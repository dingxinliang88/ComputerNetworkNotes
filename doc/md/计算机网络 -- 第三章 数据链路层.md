[toc]



# 计算机网络 -- 第三章 数据链路层

## 3.1 数据链路层概述

### 1、数据链路层在网络体系结构中所处的地位

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216110545.png)

### 2、链路、数据链路和帧

- 链路(Link)是指从一个节点到相邻节点的一段物理线路（有线或无线），而**中间没有任何其他的交换节点**
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216110819.png)
- 数据链路(Data Link)是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把**实现这些协议的硬件和软件加到链路上**，就构成了数据链路
- 计算机中的网络适配器（俗称**网卡**）和其相应的**软件驱动程序**就实现了这些协议。**一般的网络适配器都包含了物理层和数据链路层这两层的功能**
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216111105.png)
- 帧(Frame)是**数据链路层**对等实体之间在水平方向进行逻辑通信的**协议数据单元PDU(Protocol Data Unit)**
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216111314.png)
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216111332.png)

> 主机H1 到主机H2 所经过的网络可以是多种不同类型的
>
> **注意：不同的链路层可能采用不同的数据链路层协议**

**数据链路层使用的信道**

数据链路层属于计算机网路的低层。**数据链路层使用的信道主要有以下两种类型：**

- 点对点信道
- 广播信道

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216111455.png)

> **局域网属于数据链路层**
>
> 局域网虽然是个网络。但我们并不把局域网放在网络层中讨论。这是因为在网络层要讨论的是多个网络互连的问题，是讨论分组怎么从一个网络，通过路由器，转发到另一个网络。
>
> 而在同一个局域网中，分组怎么从一台主机传送到另一台主机，但并不经过路由器转发。从整个互联网来看，**局域网仍属于数据链路层**的范围

## 3.2 数据链路层的三个重要问题

- 封装成帧和透明传输
- 差错检测
- 可靠传输

**封装成帧**

- **封装成帧** (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧
- 首部和尾部的一个重要作用就是进行**帧定界**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216112438.png)

**透明传输**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216112515.png)
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216112533.png)

> ​        如果不解决上述问题，则数据链路层就会对上层交付的PDU的内容有所限制，即PDU中不能包含帧定界符。显然，这样的数据链路层没有什么应用价值
> ​         如果能够采取措施，使得数据链路层对上层交付的PDU的内容没有任何限制，就好像数据链路层不存在一样，就称其为**透明传输**

**差错检测**

在传输过程中可能会产生**比特差错**：1 可能会变成 0， 而 0 也可能变成 1

接收方根据发送方添加在帧尾部中的检错码，可以检测出帧是否出现了误码

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216112656.png)

**可靠传输**

不可靠传输服务：收到有误码的帧，直接丢弃，其他什么也不做；未收到发送方发送的帧，也不进行任何处理

**如果数据链路层向其上层提供的是可靠服务，那就还需要其他措施，来确保接收方主机还可以重新收到被丢弃的这个帧的正确副本**

### 3.2.1 封装成帧和透明传输

#### 1、封装成帧

 - 封装成帧是指数据链路层给上层交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧。

   - 帧的首部和尾部中包含有一些**重要的控制信息**
       ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216150537.png)

   - 帧首部和尾部的作用之一就是**帧定界**
     ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216150608.png)
     但并不是每一种数据链路层协议的帧都包含有帧定界标志

     ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216150730.png)

     > 前导码
     >
     > - 前同步码：作用是使接收方的时钟同步
     >
     > - 帧开始定界符：表明其后面紧跟着的就是MAC帧

     另外以太网还规定了帧间间隔为96比特时间，因此，MAC帧不需要帧结束定界符
     ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216150834.png)

 - 为了提高数据链路层传输帧的效率，应当使**帧的数据载荷的长度尽可能地大于首部和尾部的长度**

 - 考虑到对缓存空间的需求以及差错控制等诸多因素，每一种数据链路层协议都规定了帧的数据载荷的长度上限，即**最大传送单元**（Maximum Transfer Unit，**MTU**）。例如，以太网的MTU为1500个字节
   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216150955.png)

#### 2、透明传输

- 透明传输是指**数据链路层对上层交付下来的协议数据单元PDU没有任何限制**，就好像数据链路层不存在一样

帧界定标志也就是个特定数据值，如果在上层交付的协议数据单元中， 恰好也包含这个特定数值，接收方就不能正确接收
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216151124.png)
=> 所以数据链路层应该对上层交付的数据有限制，其内容不能包含帧定界符的值

**解决透明传输问题**
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216151321.png)

- **解决方法**：面向字节的物理链路使用**字节填充** (byte stuffing) 或**字符填充** (character stuffing)，面向比特的物理链路使用比特填充的方法实现透明传输
- 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)
- 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符
- 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216151510.png)
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216151528.png)

### 3.2.2 差错检测

#### 1、误码相关概念

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错（称为**比特差错**）：
  - 比特1可能变成比特0
  - 比特0可能变成比特1
- 在一段时间内，传输错误的比特数量占所传输比特总数的比率称为**误码率**（Bit Error Rate，BER）
- **提高链路的信噪比**，可以**降低误码率**。但在实际的通信链路上，不可能使误码率下降为零。
- 使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216151846.png)

#### 2、奇偶校验

- 奇校验是在待发送的数据后面**添加1个校验位**，使得添加该校验位后的整个数据中**比特1的个数为奇数**
- **偶校验是在待发送的数据后面添加**1个校验位，使得添加该校验位后的整个数据中**比特1的个数为偶数**
- 在所传输的数据中，如果有**奇数个位发生误码**，则所包含比特1的数量的奇偶性会发生改变，**可以检测出误码**
- 在所传输的数据中，如果有**偶数个位发生误码**，则所包含比特1的数量的奇偶性不会发生改变，**无法检测出误码（漏检）**。
- 在实际使用时，奇偶校验又可分为垂直奇偶校验、水平奇偶校验以及水平垂直奇偶校验。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152052.png)

#### 3、循环冗余校验

- 数据链路层广泛使用**漏检率极低**的循环冗余校验（Cyclic Redundancy Check，**CRC**）检错技术

- 循环冗余校验CRC的基本思想：

  - 收发双方约定好一个**生成多项式G(X)**
  - 发送方基于待发送的数据和生成多项式G(X),计算出差错检测码（**冗余码**），将冗余码添加到待发送数据的后面一起传输。
  - 收方收到数据和冗余码后，通过生成多项式G()来计算收到的数据和冗余码是否产生了误码

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152324.png)
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152348.png)
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152427.png)

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152500.png)
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152522.png)

### 3.2.3 可靠传输

#### 1、可靠传输相关概念

- 使用**差错检测技术**（例如循环冗余校验CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了**误码**（比特差错）
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216152658.png)
- 数据链路层向其上层提供的服务类型
  - **不可靠传输服务**：**仅仅丢弃有误码的帧**，其他什么也不做：
  - **可靠传输服务**：通过某种机制实现**发送方发送什么，接收方最终就能收到什么**
- 一般情况下，**有线链路的误码率比较低**。为了减小开销，**并不要求数据链路层向其上层提供可靠传输服务**。即使出现了误码，可靠传输的问题由其上层处理。
- **无线链路**易受干扰，**误码率比较高**，因此**要求数据链路层必须向其上层提供可靠传输服务**

**传输差错**

- **比特差错**
- （从整个计算机网络体系结构来看），传输差错还包括**分组丢失**、**分组失序**、**分组重复**



- 分组丢失
  路由器输入队列快满了，主动丢弃收到的分组
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216154524.png)

- 分组失序
  数据并未按照发送顺序依次到达接收端

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216154759.png)

- 分组重复
  由于某些原因，有些分组在网络中滞留了，没有及时到达接收端，这可能会造成发送端对该分组的重发，重发的分组到达接收端，但一段时间后，滞留在网络的分组也到达了接收端，这就造成**分组重复**的传输差错

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216154901.png)



**可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输。
可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求。
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216155328.png)

#### 2、停止-等待协议的实现原理

- 确认、否认和重传
  ![image-20221216155514676](C:/Users/d1741/AppData/Roaming/Typora/typora-user-images/image-20221216155514676.png)

> - 接收方收不到数据分组，就不会发送相应的ACK或NAK。
> - 如果不采取措施，发送方就会一直处于等待接收方ACK或NAK的状态
> - 为解决上述问题，发送方可在每发送完一个数据分组时就启动一个**超时计时器(Timeout Timer)**
> - 若到了超时计时器所设置的超时重传时间(Retransmission Time-Out,RTO),但发送方仍未收到接收方的ACK或NAK,就重传之前已发送过的数据分组。

- 超时重传
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216155807.png)

  > - 为了**避免分组重复**这种传输错误，必须**给每个分组带上序号**
  > - 对于停止-等待协议，由于每发送一个数据分组就停止等待，只要保证每发送一个新的数据分组，其序号与上次发送的数据分组的序号不同就可以了，**因此用一个比特来编号就够了，序号有0和1这两个**

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216155948.png)
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216160133.png)

**注意事项**

- 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传**
- 为了让接收方能够判断所收到的数据分组是否是重复的，需要给数据分组编号。由于停止-等待协议的特性，**只需1个比特编序号即可**，即序号0和序号1
- 为了让发送方能够判断所收到的确认分组是否是重复的，需要给**确认分组编号**，所用比特数量**与数据分组所用比特数量一样**
  - 数据链路层一般不会出现确认分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给确认分组编号**
- 给超时计时器设置的超时重传时间RTO应当仔细选择，**一般将RTO设置为略大于收发双方的平均往返时间RTT**
  - 在数据链路层，点对点的往返时间RTT比较固定，RTO就比较好设定
  - 在运输层，由于端到端往返时间非常不确定，设置合适的超时重传时间RTO有时并不容易
- 停止-等待协议属于自动请求重传（Automatic Repeat reQuest，**ARQ**）协议。即重传的请求是发送方自动进行的，而不是接收方请求发送方重传某个误码的数据分组

#### 3、停止-等待协议的信道利用率

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216160737.png)
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216160902.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216160956.png)

#### 4、回退N帧协议

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161039.png)

> - 在使用流水线传输方式时，发送方**不能无限制地连续发送数据分组**，否则可能会导致网络中的路由器或接收方来不及处理这些数据分组，进而导致数据分组的丢失，这实际上是对网络资源的浪费
> - 回退N帧协议采用流水线传输方式，并且利用**发送窗口**来限制发送方连续发送数据分组的数量，这属于**连续ARQ协议**

回退N帧协议在流水线传输的基础上，利用发送窗口来限制发送方可连续发送数据分组的个数

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161316.png)

**无差错情况流程**

发送方将序号落在发送窗口内的0~4号数据分组，依次连续发送出去

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161456.png)

他们经过互联网传输正确到达接收方，就是没有乱序和误码，接收方按序接收它们，每接收一个，接收窗口就向前滑动一个位置，并给发送方发送针对所接收分组的确认分组，在通过互联网的传输正确到达了发送方

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161531.png)

发送方每接收一个、发送窗口就向前滑动一个位置，这样就有新的序号落入发送窗口，发送方可以将收到确认的数据分组从缓存中删除了，而接收方可以择机将已接收的数据分组交付上层处理

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161637.png)



**累计确认**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161718.png)

> 累计确认优缺点
>
> 优点:
>
> - 即使确认分组丢失，发送方也可能不必重传
>
> - 减小接收方的开销
>
> - 减小对网络资源的占用
>
> 缺点：
>
> - 不能向发送方及时反映出接收方已经正确接收的数据分组信息



**有差错情况**

例如：在传输数据分组时，5号数据分组出现误码，接收方通过数据分组中的检错码发现了错误
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161820.png)

于是丢弃该分组，而后续到达的这剩下四个分组与接收窗口的序号不匹配
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221216161923.png)

接收同样也不能接收它们，讲它们丢弃，并对之前按序接收的最后一个数据分组进行确认，发送ACK4，**每丢弃一个数据分组，就发送一个ACK4**
![24878825-c3f86dad2611e347.png (1877×311)](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/24878825-c3f86dad2611e347.png)

当收到重复的ACK4时，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻开始重传，具体收到几个重复确认就立刻重传，根据具体实现决定
![24878825-215e8704b22ef7f2.png (1909×503)](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/24878825-215e8704b22ef7f2.png)

如果收到这4个重复的确认并不会触发发送立刻重传，一段时间后。超时计时器超时，也会将发送窗口内以发送过的这些数据分组全部重传
![img](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/24878825-1df324a9b09dffb4.png)

若WT超过取值范围，例如WT=8，会出现什么情况？
![img](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/24878825-d2789fe0732f13ba.png)

![image-20221216162246839](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162246839.png)
![image-20221216162312800](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162312800.png)

**总结**
![image-20221216162337415](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162337415.png)

#### 5、选择重传协议

从**滑动窗口**的角度对比停止-等待协议、回退N帧协议和选择重传协议

![image-20221216162407456](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162407456.png)

> ​     为了使发送方仅重传出现差错的数据分组，接收方**不再采用累积确认**，而需要对每一个正确接收的数据分组进行**逐一确认**

**流程**

![image-20221216162550497](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162550497.png)
![image-20221216162612070](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162612070.png)
![image-20221216162704534](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162704534.png)
![image-20221216162724409](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162724409.png)
![image-20221216162751463](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162751463.png)
![image-20221216162820424](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162820424.png)
![image-20221216162910335](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216162910335.png)

故意取W<sub>T</sub>=5，使得W<sub>T</sub>+W<sub>R</sub>≥2<sup>3</sup>，接收方将无法分辨新旧数据分组
![image-20221216163234532](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163234532.png)
![image-20221216163311288](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163311288.png)
因为一些特殊原因，ACK0丢失了
![image-20221216163354615](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163354615.png)
![image-20221216163419453](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163419453.png)

![image-20221216163443101](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163443101.png)

**总结**
![image-20221216163506398](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221216163506398.png)



## 3.3 点对点协议

### 1、点对点协议PPP概述

点对点协议（Point-to-Point Protocol，**PPP**）是目前使用最广泛的点对点数据链路层协议

点对点协议PPP是因特网工程任务组（Internet Engineering Task Force，**IETF**）于1992年制定的。经过多次修订，目前PPP已成为因特网的正式标准[RFC1661，RFC1662]

点对点协议PPP主要有两种应用：
![image-20221217185142373](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217185142373.png)

从网络体系结构的角度看点对点协议PPP的组成：
![image-20221217185245573](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217185245573.png)

### 2、PPP的帧格式

![image-20221217185317384](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217185317384.png)

- **标志**(Flag)字段：PPP帧的定界符，取值为0x7E
- **地址**(Address)字段：取值为0xFF
- **控制**(Control)字段：取值为0x03
- **协议**(Protocol)字段：其值用来指明帧的数据载荷应向上交付给哪个协议处理
  ![image-20221217185553045](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217185553045.png)
- **帧检验序列**(Frame Check Swquence,FCS)字段：其值是使用循环冗余检验CRC计算出的验错码

### 3、PPP帧的透明传输

问题：
![image-20221217185825289](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217185825289.png)

**标志**(Flag)字段：PPP帧的定界符，取值为

- 从字节角度来看：取值为0x7E
- 从比特角度来看：取值为01111110

**面向字节的异步链路使用字节填充来实现透明传输[RFC1662]**

![image-20221217190141855](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217190141855.png)

**面向比特的同步链路使用零比特填充来实现透明传输**

![image-20221217190229006](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217190229006.png)

### 4、PPP帧的差错检测

![image-20221217190315470](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217190315470.png)

接收方每收到一个PPP帧，就进行CRC检验。若CRC检验正确，就收下这个帧；否则，就丢弃这个帧。

 使用PPP的数据链路层，**向上提供的是不可靠数据传输服务**

### 5、PPP的工作状态

以用户主机拨号接入因特网服务提供者ISP的拨号服务器的过程为例
![image-20221217190615016](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221217190615016.png)

## 3.4 共享式以太网

1975年以太网诞生

- 以太网（**Ethernet**）以曾经被假想的电磁波传播介质——**以太（Ether）**来命名
- 以太网最初采用无源电缆（不包含电源线）作为共享总线来传输帧，属于基带总线局域网，传输速率为2.94Mb/s

![image-20221218101334658](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218101334658.png)

![image-20221218101346490](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218101346490.png)

![image-20221218101633237](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218101633237.png)

>   以太网目前已经从传统的**共享式以太网**发展到**交换式以太网**，传输速率已经从10Mb/s提高到100Mb/s、1Gb/s甚至10Gb/s

### 3.4.1 网络适配器和MAC地址

#### 1、网络适配器

1）要将计算机连接到以太网，需要使用相应的**网络适配器**(Adapter)，网络适配器一般简称为**“网卡”**

![image-20221218101824317](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218101824317.png)

![image-20221218101845152](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218101845152.png)

2）在计算机内部，**网卡与CPU**之间的通信，一般是通过计算机主板上的I/O总线以**并行传输**方式进行

3）**网卡与外部以太网**（局域网）之间的通信，一般是通过传输媒体（同轴电缆、双绞线电缆、光纤）以**串行方式**进行的

![image-20221218102026930](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218102026930.png)

4）网卡除要**实现物理层和数据链路层功能**，其另外一个重要功能就是要进行**并行传输和串行传输的转换**。由于网络的传输速率和计算机内部总线上的传输速率并不相同，因此在网卡的核心芯片中都会包含用于缓存数据的存储器

5）在确保网卡硬件正确的情况下，为了使网卡正常工作，还必须要在计算机的操作系统中为网卡安装相应的设备驱动程序。**驱动程序**负责驱动网卡发送和接收帧

#### 2、MAC地址

![image-20221218102203902](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218102203902.png)

1）当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个**唯一的标识**，即一个**数据链路层地址**

2）在每个主机发送的**帧的首部**中，都**携带**有发送主机（源主机）和接收主机（目的主机）的**数据链路层地址**。由于这类地址是用于**媒体接入控制**（Medium Access Control，MAC）的，因此被称为**MAC地址**

![image-20221218102416305](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218102416305.png)

3）**MAC地址**一般被固化在网卡的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**

4）MAC地址有时也被称为**物理地址**

>  不要被物理地址中的“物理”二字误导，误认为物理地址属于网络体系结构中物理层的范畴。
> 物理地址属于数据链路层范畴

![image-20221218102616696](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218102616696.png)

5） 一般情况下，普通用户计算机中往往会包含两块网卡：

- 一块是用于接入有线局域网的**以太网卡**
- 另一块是用于接入无线局域网的**Wi-Fi网卡**

6）每块网卡都有一个**全球唯一的MAC地址**

7）交换机和路由器往往具有更多的网络接口，所以会拥有更多的MAC地址

综上所述，严格来说，MAC地址是对网络上**各接口**的唯一标识，而不是对网络上各设备的唯一标识



IEEE 802局域网的MAC地址格式

![image-20221218102948656](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218102948656.png)

![image-20221218103104609](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103104609.png)

> 全球多播--多播地址：例如，交换机的生成树协议STP使用的多播地址为01-80-C2-00-00-00
>
> 本地多播：剩余46比特为“全1”时，就是广播地址FF-FF-FF-FF-FF-FF

![image-20221218103240606](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103240606.png)

**单播MAC地址举例**

![image-20221218103318215](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103318215.png)
![image-20221218103333176](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103333176.png)

**广播MAC地址举例**

![image-20221218103407402](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103407402.png)
![image-20221218103423515](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103423515.png)

**多播MAC地址举例**

![image-20221218103459401](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218103459401.png)

网卡从网络上每收到一个帧，就检查帧首部4的目的MAC地址，按如下情况处理：

- 如果目的MAC地址是广播地址(FF-FF-FF-FF-FF-FF),则接受该帧
- 如果目的MAC地址与网卡上固化的全球单播MAC地址相同，则接受该帧
- 如果目的MAC地址是网卡支持的多播地址，则接受该帧
- 除上述三种情况外，丢弃该帧

网卡还可被设置为一种特殊的工作方式：**混杂方式**（Promiscuous Mode）。工作在混杂方式的网卡，只要收到共享媒体上传来的帧就会收下，而不管帧的目的MAC地址是什么

- 对于网络维护和管理人员，这种方式可以监视和分析局域网上的流量，以便找出提高网络性能的具体措施
- **嗅探器**（Sniffer）就是一种工作在混杂方式的网卡，再配合相应的工具软件（WireShark），就可以作为一种非常有用的网络工具来学习和分析网络
- 混杂方式就像一把“双刃剑”，黑客常利用这种方式非法获取网络用户的口令

> 全球单播MAC地址就如同身份证上的身份证号码，具有唯一性，它往往与用户个人信息绑定在一起。因此，用户应尽量**确保自己拥有的全球单播MAC地址不被泄露**
>
> 为了避免用户设备连接Wi-Fi热点时MAC地址泄露的安全问题，目前大多数移动设备都已经采用了**随机MAC地址技术**

### 3.2.2 CSMA/CD协议

#### 1、CSMA/CD协议的基本原理

1）在以太网的发展初期，人们普遍认为“无源的电缆线比有源器件可靠”，因此将多个站点连接在一条总线上来构建**共享总线以太网**

2）共享总线以太网具有**天然的广播特性**，即使总线上某个站点给另一个站点发送单播帧，表示帧的信号也会沿着总线传播到总线上的其他各站点

![image-20221218104048906](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104048906.png)

3）当某个站点在总线上发送帧时，总线资源会被该站点独占。此时，如果总线上的其他站点也要在总线上发送帧，就会产生**信号碰撞**

4）当两个或多个站点同时使用总线发送帧时，就会产生信号碰撞

![image-20221218104136678](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104136678.png)

> 共享总线以太网的一个重要问题：**如何协调总线上的各站点争用总线**

5）为了解决各站点争用总线的问题，共享总线以太网使用了一种专用协议**CSMA/CD**，它是**载波监听多址接入/碰撞检测**（Carrier Sense Multiple Access Collision Detection）的英文缩写词

![image-20221218104310674](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104310674.png)

![image-20221218104353916](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104353916.png)

> **强化碰撞**
>
> 发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送**32比特或48比特的人为干扰信号**（Jamming Signal），以便有**足够多的碰撞信号使所有站点都能检测出碰撞**

载波监听检测到总线空闲，但**总线并不一定空闲**

使用CSMA/CD协议的共享总线以太网上的各站点，只是尽量避免碰撞并在出现碰撞时做出退避后重发的处理，但**不能完全避免碰撞**

在使用CSMA/CD协议时，由于正在发送帧的站点必须“边发送帧边检测碰撞”，因此站点不可能同时进行发送和接收，也就是不可能进行全双工通信，而**只能进行半双工通信**（双向交替通信）

![image-20221218104540447](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104540447.png)
![image-20221218104558583](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104558583.png)
![image-20221218104615297](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104615297.png)
![image-20221218104627443](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104627443.png)

#### 2、共享式以太网的争用期

1）使用CSMA/CD协议的共享总线以太网上的任意站点在发送帧的过程中都可能会遭遇碰撞

![image-20221218104913287](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104913287.png)
![image-20221218104935584](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218104935584.png)

站点从发送帧开始，最多经过时长2τ （即δ→0）就可检测出所发送的帧是否遭遇了碰撞，因此，共享总线以太网的**端到端往返时间2τ**被称为**争用期**（Contention Period）或**碰撞窗口**（Collision Window），它是一个非常重要的参数

- 站点从发送帧开始，**经过争用期2τ这段时间还没有检测到碰撞，就可以肯定这次发送不会产生碰撞**

从争用期的概念可以看出，共享总线以太网上的每一个站点从发送帧开始，到之后的一小段时间内，都有可能遭遇碰撞，而**这一小段时间的长短是不确定的**，它**取决于另一个发送帧的站点与本站点的距离**，但不会超过总线的端到端往返传播时延，即一个争用期2τ 

- 很显然，总线的长度越长（单程端到端传播时延越大），网络中站点数量越多，发生碰撞的概率就越大
- 因此，共享以太网的总线长度不能太长，接入的站点数量也不能太多

![image-20221218105132934](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105132934.png)


![image-20221218105200021](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105200021.png)

#### 3、共享式以太网的最小帧长和最大帧长

![image-20221218105242039](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105242039.png)
![image-20221218105256559](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105256559.png)

1）为了确保共享总线以太网上的每一个站点在发送完一个完整的帧之前，能够检测出是否产生了碰撞，**帧的发送时延就不能少于共享总线以太网端到端的往返时间**，即一个争用期2τ

2）对于10Mb/s的共享总线以太网，其争用期2τ 的值规定为51.2μs，因此其**最小帧长为512b，即64B**

`10Mb/s×51.2μs=512b=64B`

- 当某个站点在发送帧时，如果帧的前64B没有遭遇碰撞，那么帧的后续部分也就不会遭遇碰撞。也就是说，如果遭遇碰撞，就一定是在帧的前64B之内
- 由于发送帧的站点边发送帧边检测碰撞，一旦检测到碰撞就立即中止帧的发送，此时已发送的数据量一定小于64B。因此，接收站点收到**长度小于64B的帧**，就可判定这是一个**遭遇了碰撞而异常中止的无效帧**，将其丢弃即可

3）一般来说，**帧的数据载荷的长度应远大于帧首部和尾部的总长度**，这样可以**提高帧的传输效率**

![image-20221218105553152](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105553152.png)

然而，如果不限制数据载荷的长度上限，就可能使得**帧的长度太长**，这会**带来一些问题**

![image-20221218105620918](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105620918.png)

![image-20221218105635334](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105635334.png)

![image-20221218105650280](C:/Users/d1741/AppData/Roaming/Typora/typora-user-images/image-20221218105650280.png)

#### 4、共享式以太网的退避算法

1）在使用CSMA/CD协议的共享总线以太网中，正在发送帧的站点一边发送帧一边检测碰撞，当检测到碰撞时就立即停止发送，**退避一段随机时间**后再重新发送

2）共享总线以太网中的各站点采用**截断二进制指数退避**（Truncated Binary Exponential Backoff）算法来选择退避的随机时间

![image-20221218105746242](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105746242.png)

3）如果连续多次发送碰撞，就表明可能有较多的站点参与竞争信道。但使用上述退避算法可**使重传需要推迟的平均时间随重传次数而增大**（即**动态退避**），因而**减小产生碰撞的概率**

4）**当重传达16次仍不能成功时**，就表明同时打算发送帧的站点太多，以至于连续产生碰撞，此时应**放弃重传**并向高层报告

![image-20221218105920957](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105920957.png)
![image-20221218105900851](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218105900851.png)

![image-20221218105936774](C:/Users/d1741/AppData/Roaming/Typora/typora-user-images/image-20221218105936774.png)

### 3.4.3 使用集线器的共享式以太网

#### 1、使用集线器的共享式以太网

1）早期的传统以太网是使用**粗同轴电缆**的共享**总线**以太网，后来发展到使用价格相对便宜的**细同轴电缆**

2）当初认为这种连接方法既简单又可靠，因为在那个时代普遍认为**有源器件不可**靠，而**无源的电缆线才是最可靠的**

- 然而，实践证明这种使用**无源电缆线和大量机械接口**的总线型以太网**并不**像人们想象的那么**可靠**

![image-20221218110208792](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110208792.png)

3）在使用细同轴电缆的共享总线以太网之后，以太网发展出来了一种使用大规模集成电路来替代总线、并且可靠性非常高的设备，叫作**集线器（Hub）**

4）站点连接到集线器的传输媒体也转而使用更便宜、更灵活的**双绞线电缆**

5）集线器的一些主要特点如下：

- 使用集线器的以太网虽然**物理拓扑是星型**的，但在**逻辑上**仍然是一个**总线网**。总线上的各站点共享总线资源，**使用的还是CSMA/CD协议**
- 集线器**只工作在物理层**，它的每个接口仅简单地转发比特，并不进行碰撞检测。碰撞检测的任务由各站点中的网卡负责
- 集线器一般都**有少量的容错能力和网络管理功能**。例如，若网络中某个站点的网卡出现了故障而不停地发送帧，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网能正常工作

![image-20221218110423035](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110423035.png)

6）IEEE于1990年制定了**10BASE-T**星型以太网的标准802.3i，这种以太网是局域网发展史上的一座非常重要的里程碑，它为**以太网在局域网中的统治地位**奠定了牢固的基础

7）10BASE-T以太网的通信距离较短，每个**站点到集线器的距离不能超过100m**

8）IEEE 802.3以太网还可使用光纤作为传输媒体，相应的标准为10BASE-F，“F”表示光纤。光纤主要用作集线器之间的远程连接

![image-20221218110531058](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110531058.png)

![image-20221218110548282](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110548282.png)

### 3.4.4 在物理层扩展以太网

#### 1、扩展站点与集线器之间的距离

1）共享总线以太网中两站点之间的**距离不能太远**，否则它们之间所传输的信号就会**衰减到使CSMA/CD协议无法正常工作**

2）在早期广泛使用粗同轴电缆或细同轴电缆共享总线以太网时，为了提高网络的地理覆盖范围，常用的是**工作在物理层的转发器**

3）IEEE 802.3标准规定，两个网段可用一个转发器连接起来，任意两个站点之间最多可以经过三个网段。

![image-20221218110714206](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110714206.png)

4）随着使用双绞线和集线器的10BASE-T星型以太网成为以太网的主流类型，扩展网络覆盖范围就很少使用转发器了

5）10BASE-T星型以太网中每个站点到集线器的距离不能超过100m，因此两站点间的通信距离最大不能超过200m

![image-20221218110754189](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110754189.png)

6）在10BASE-T星型以太网中，可使用**光纤**和一对**光纤调制解调器**来**扩展站点与集线器之间的距离**

- 这种扩展方法比较简单，所需付出的代价是：为站点和集线器各增加一个用于电信号和光信号转换的光纤调制解调器，以及它们之间的一对通信光纤

7）信号在光纤中的衰减和失真很小，因此使用这种方法可以很简单地将站点与集线器之间的距离扩展到1000以上

![image-20221218110849408](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110849408.png)

#### 2、扩展共享式以太网的覆盖范围和站点数量

1）以太网集线器一般具有8~32个接口，如果要连接的站点数量超过了单个集线器能够提供的接口数量，就需要使用多个集线器，这样就可以连接成覆盖更大范围、连接更多站点的多级星型以太网

![image-20221218110958818](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218110958818.png)

2）采用多个集线器连接而成的多级星型以太网，在扩展了网络覆盖范围和站点数量的同时，也带来了一些负面因素

![image-20221218111017867](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111017867.png)
![image-20221218111029038](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111029038.png)

在物理层扩展的共享式以太网仍然是一个碰撞域，不能连接太多的站点，否则可能会出现大量的碰撞，导致**平均吞吐量太低**

### 3.4.5 在数据链路层扩展以太网

#### 1、使用网桥在数据链路层扩展以太网

![image-20221218111305831](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111305831.png)

1）网桥(bridge)工作在数据链路层（包含其下的物理层），因此**网桥具备属于数据链路层范畴的相关能力**

- 网桥可以**识别帧的结构**
- 网桥可以根据帧首部中的**目的MAC地址**和网桥自身的**帧转发表**来转发或丢弃所收到的帧

#### 2、网桥的主要结构和基本工作原理

![image-20221218111733483](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111733483.png)

![image-20221218111816488](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111816488.png)

![image-20221218111832629](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111832629.png)

![image-20221218111844112](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111844112.png)

![image-20221218111857759](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218111857759.png)

网桥的接口在向其连接的网段转发帧时，会执行相应的媒体接入控制协议，对于共享式以太网就是CSMA/CD协议

#### 3、透明网桥的自学习和转发帧的流程

> 网桥中的转发表对于帧的转发起着决定性的作用
>
> 转发表是如何建立的？

1）透明网桥（Transparent Bridge）通过**自学习**算法建立转发表

2）透明网桥中的“**透明**”，是指以太网中的各站点并不知道自己所发送的帧将会经过哪些网桥的转发，最终到达目的站点。也就是说，**以太网中的各网桥对于各站点而言是看不见的**

3）透明网桥的标准是IEEE 802.1D，它通过一种自学习算法**基于以太网中各站点间的相互通信**逐步建立起自己的转发表

![image-20221218112130714](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218112130714.png)

![image-20221218112147188](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218112147188.png)

![image-20221218112222070](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218112222070.png)

![image-20221218112240200](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218112240200.png)

4）自学习流程

- 网桥收到帧后进行**登记（即自学习）**，登记的内容为帧的**源MAC地址**和进入网桥的**接口号**

- 网桥根据帧的**目的MAC地址**和网桥的**转发表**对帧进行**转发**，包含以下三种情况：

  - **明确转发**：网桥知道应当从哪个接口转发帧
  - **盲目转发**：网桥不知道应当从哪个接口转发帧，只能将其通过除进入网桥的接口外的其他所有接口转发
  - **丢弃**：网桥知道不应该转发该帧，将其丢弃

  > 注意事项
  >
  > - 如果网桥收到有**误码的帧**则直接**丢弃**
  > - 如果网桥收到一个无误码的**广播帧**，则不用进行查表，而是直接从除接收该广播帧的接口的**其他接口**转发该广播帧
  > - 转发表中的每条记录都有其**有效时间，到期自动删除**！这是因为各站点的MAC地址与网桥接口的对应关系并不是永久性的，例如某个站点更换了网卡，其MAC地址就会改变

#### 4、透明网桥的生成树协议STP

1）为了提高以太网的**可靠性**，有时需要在两个以太网之间使用多个透明网桥来提供**冗余链路**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218112654.png)

2）在增加冗余链路提高以太网可靠性的同时，却给网络引入了**环路**

3）网络中的**广播帧将在环路中永久兜圈**，造成广播帧充斥整个网络，**网络资源被白白浪费**，而网络中的主机之间无法正常通信

4）为了避免广播帧在环路中永久兜圈，透明网桥使用**生成树协议**（Spanning Tree Protocol，**STP**），可以在增加冗余链路提高网络可靠性的同时，又避免环路带来的问题

- 不管网桥之间连接成了怎样复杂的带环拓扑，网桥之间通过**交互网桥协议单元**（Bridge Protocol Data Unit，**BPDU**），**找出原网络拓扑的一个连通子集（即生成树）**，在这个子集里整个连通的网络中**不存在环路

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218112840.png)

- 当首次连接网桥或网络拓扑发生变化时（人为改变或出现故障），网桥都会重新构造生成树，以确保网络的连通

  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218112902.png)

## 3.5 交换式以太网

### 1、交换式以太网

1）网桥的**接口数量很少**，通常只有2~4个，一般只用来**连接不同的网段**

2）1990年面世的**交换式集线器**（Switching Hub），实质上是**具有多个接口的网桥**，常称为**以太网交换机**（Switch）或二层交换机

- “二层”是指以太网交换机工作在数据链路层（包括物理层）
- 与网桥相同，交换机内部的转发表也是通过自学习算法，基于网络中各主机间的通信，自动地逐步建立起来的
- 另外，交换机也使用生成树协议STP，来产生能够连通全网但不产生环路的通信路径

3）仅使用交换机（而不使用集线器）的以太网就是交换式以太网。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113130.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113216.png)

### 2、以太网交换机

1）以太网交换机（以下简称交换机）本质上就是一个多接口的网桥：

- 交换机自学习和转发帧的流程与网桥是相同的
- 另外，交换机也使用生成树协议STP，来产生能够连通全网但不产生环路的通信路径

2）交换机的每个接口可以连接**计算机**，也可以连接**集线器**或另一个**交换机**

- 当交换机的**接口与计算机或交换机连接**时，可以工作在**全双工方式**，并能**在自身内部同时连通多对接口**，使每一对相互通信的计算机都能像独占传输媒体那样，无碰撞地传输数据，这样就**不需要使用CSMA/CD协议了**
- 当交换机的**接口连接的是集线器**时，该接口就**只能使用CSMA/CD协议**并只能工作在**半双工方式**
- 现在的交换机和计算机中的网卡都能自动识别上述两种情况，并自动切换到相应的工作方式。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113412.png)

3）交换机一般都具有多种速率的接口，例如10Mb/s、100Mb/s、1Gb/s甚至10Gb/s的接口，大部分接口支持多速率自适应。

![image-20221218113528381](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218113528381.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113601.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113640.png)

![image-20221218113704551](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218113704551.png)

![image-20221218113718503](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218113718503.png)

4）一般的交换机都采用“**存储转发”**方式，为了减小交换机的转发时延，某些交换机采用了**直通**（Cut-Through）交换方式

5）采用**直通交换方式**的交换机，在**接收帧的同时就立即按帧的目的MAC地址决定该帧的转发接口**，然后通过其内部**基于硬件的交叉矩阵**进行转发，而不必把整个帧先缓存后再进行处理。

- 直通交换的**时延非常小**
- 直通交换**不检查差错就直接将帧转发出去**，有可能会将一些无效帧转发给其他主机

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221218113928.png)

### 3、共享式以太网和交换式以太网的对比（集线器和交换机的对比）

![image-20221218114033661](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114033661.png)

![image-20221218114048935](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114048935.png)

![image-20221218114105797](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114105797.png)

![image-20221218114120197](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114120197.png)

![image-20221218114133421](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114133421.png)

=>  交换式以太网的网络性能远高于共享式以太网，集线器早已被交换机取代

![image-20221218114158648](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114158648.png)
![image-20221218114217054](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114217054.png)
![image-20221218114231688](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114231688.png)
![image-20221218114246561](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114246561.png)

![image-20221218114315116](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114315116.png)
![image-20221218114328314](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114328314.png)
![image-20221218114340446](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114340446.png)

![image-20221218114355469](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221218114355469.png)

## 3.6 以太网的MAC帧格式

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219154935.png)
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219155007.png)

目标地址 && 源地址：用来填入**帧的目的MAC地址和源MAC地址**

类型：其值用来指明**数据载荷**中的内容是由上一层的哪个**协议**封装的，以便将收到的MAC帧的数据载荷上交给上一层的这个协议
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219155259.png)

FCS：使用**CRC**生成的帧检验序列FCS，接收方的网卡通过FCS的内容就可**检测**出帧在传输过程中是否产生了**误码**

> CRC检验范围：目标地址 + 源地址 + 类型 + 数据载荷

数据载荷：

- 满足最小帧长为64B的要求（6B + 6B + 2B + 46B + 4B = 64B ）
- 数据载荷的最大长度被限制为1500B => 以太网V2的MAC帧最大长度为1518B



![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219155544.png)

1）接收方可能收到的无效MAC帧包括一下几种：

- MAC帧的长度不是整数个字节
-  通过MAC帧的FCS字段的值检测出帧有误码
- MAC帧的长度不在64~1518字节之间

> 接收方收到无效的MAC帧时，就简单将其丢弃，以太网的数据链路层没有重传机制



## 3.7 虚拟局域网

### 1、局域网VLAN的诞生背景

1）将多个站点通过一个或多个**以太网交换机**连接起来就构建出了交换式以太网

2）交换式以太网中的所有站点都属于**同一个广播域**

3）随着交换式以太网规模的扩大，广播域也相应扩大

4）**巨大的广播域会带来一系列问题**

- 广播风暴（广播风暴会浪费网络资源和各主机的CPU资源）
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160059.png)
- 难以管理和维护，带来潜在的安全问题

5）TCP/IP协议栈中的很多协议都会使用广播：

- 地址解析协议ARP
- 路由信息协议RIPv1
- 动态主机配置协议DHCP

6）NetBEU:Windows下使用的广播型协议

7）IPX/SPX:Novell网络的协议栈

8）Apple Talk:Apple公司的网络协议栈

9）**分割广播域**的方法

- 使用路由器可以隔离广播域（成本较高）
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160351.png)
- 使用虚拟局域网技术

### 2、虚拟局域网VLAN概述

1）虚拟局域网（Virtual Local Area Network，**VLAN**）是一种将局域网内的站点划分成**与物理位置无关的逻辑组**的技术，一个逻辑组就是一个VLAN，VLAN中的各站点具有某些共同的应用需求。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160520.png)

2）属于同一VLAN的站点之间可以直接进行通信，而不同VLAN中的站点之间不能直接通信

3）网络管理员可对局域网中的各交换机进行配置来建立多个逻辑上独立的VLAN

- 连接在同一交换机上的多个站点可以属于不同的VLAN，而属于同一VLAN的多个站点可以连接在不同的交换机上

> 虚拟局域网VLAN并不是一种新型网络，它只是局域网能够提供给用户的一种服务

### 3、虚拟局域网VLAN的实现机制

1）虚拟局域网VLAN有多种实现技术，最常见的就是**基于以太网交换机的接口来实现VLAN。**这就需要以太网交换机能够实现以下两个功能：

- 能够处理带有VLAN标记的帧，也就是**IEEE 802.1Q帧**
- 交换机的各接口可以支持**不同的接口类型**，不同接口类型的接口对帧的处理方式有所不同

**IEEE 802.1Q帧**

2）IEEE 802.1Q帧也称为Dot One Q帧，它对以太网V2的MAC帧格式进行了扩展：在源地址字段和类型字段之间插入了**4字节的VLAN标签**（tag）字段。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160750.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160810.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219160846.png)

3）802.1Q帧一般不由用户主机处理，而是由以太网交换机来处理

- 当交换机**收到普通的以太网MAC帧**时，会给其**插入4字节的VLAN标签使之成为802.1Q帧**，该处理简称为“**打标签**”
- 当交换机**转发802.1Q帧**时，**可能会删除其4字节的VLAN标签使之成为普通的以太网MAC帧**，该处理简称为“**去标签**”。交换机转发802.1Q帧时也有可能不进行“去标签”处理，是否进行“去标签”处理取决于交换机的接口类型



**以太网交换机的接口类型**

4）根据接口在**接收帧和发送帧时对帧的处理方式**的不同，以及**接口连接对象**的不同，以太网交换机的接口类型一般分为**Access**和**Trunk**两种

5）当以太网交换机上电启动后，若之前未对其各接口进行过VLAN的相关设置，则各接口的接口类型**默认为Access**，并且各接口的缺省VLAN ID为1，即各接口**默认属于VLAN1**

- 对于思科交换机，接口的缺省VLAN ID称为本征VLAN（Native VLAN）
- 对于华为交换机，接口的缺省VLAN ID称为端口VLAN ID（Port VLAN ID），简记为PVID

> 交换机的每个接口有且仅有一个PVID

【例1】在一个交换机上不进行人为的VLAN划分，交换机各接口默认属于VLAN1且类型为Access的情况

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161448.png)

【例2】在一个交换机上划分两个不同VLAN的情况

> 对交换机进行配置（通过界面或配置命令）
>
> - 创建VLAN2和VLAN3
> - 将接口1和2划归到VLAN2，接口3和4划归到VLAN3

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161604.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161622.png)

【例3】两个交换机通过Trunk类型的接口互连，Trunk接口将802.1Q帧“去标签”后进行转发的情况

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161658.png)

【例4】两个交换机通过Trunk类型的接口互连，Trunk接口将802.1Q帧直接转发的情况

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161720.png)

**总结**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161817.png)



![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161836.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219161856.png)



## 3.8 以太网的发展

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219162103.png)

### 1、100BASE-T以太网

1）100BASE-T以太网是指在**双绞线**上传输**基带信号**的速率为**100Mb/s**的以太网，也称为快速以太网（Fast Ethernet）

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219162150.png)

2）100BASE-T以太网与10Mb/s标准以太网（传统以太网）一样，**仍然使用IEEE 802.3的帧格式和CSMA/CD协议**

3）100BASE-T以太网为了与10Mb/s标准以太网保持兼容，需要以太网**最小帧长保持不变**，即仍为**64字节**

- 网段的最大电缆长度从1000m减小到**100m**
- 争用期缩短为**5.12μs**
- 帧间最小间隔缩短为**0.96μs**

> 100BASE-T以太网还可以使用以太网交换机来提供比集线器更好的服务质量，即在全双工方式下无碰撞工作。因此，使用交换机的100BASE-T以太网，工作在全双工方式下，并不使用CSMA/CD协议

4）1995年，IEEE的802委员会正式批准100BASE-T以太网的标准为**802.3u**。实际上，IEEE 802.3u只是对原有IEEE 802.3标准的补充

5）除100BASE-T以太网外，百兆以太网有多种不同的物理层标准：

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219162423.png)

### 2、吉比特以太网

1）**吉比特以太网**也称为**千兆以太网**（Gigabit Ethernet）。1998年，千兆以太网的标准**802.3z**成为正式标准

2）近几年来，千兆以太网已迅速占领市场，成为了以太网的主流产品

3）IEEE 802.3z千兆以太网的主要特点有：

- 速率为1000Mb/s（1Gb/s）
- 使用IEEE 802.3的帧格式（与10Mb/s和100Mb/s以太网相同）
- 支持半双工方式（使用CSMA/CD协议）和全双工方式（不使用CSMA/CD协议）
- 兼容10BASE-T和100BASE-T技术

4）当千兆以太网工作在半双工方式时，需要使用CSMA/CD协议。由于速率已经提高到了1000Mb/s，因此只有减小网段最大长度或增大最小帧长，才能使3.4.2节中介绍的以太网的参数a（τ∕T0）保持为较小的数值

- 若将网段最大长度减小到10m，则网络基本失去了应用价值
- 若将最小帧长增大到640字节，则当上层交付的待封装的协议数据单元PDU很短时，开销就会太大

> 千兆以太网的网段最大长度仍保持为100m，最小帧长仍保持为64字节（与10BASE-T和100BASE-T兼容）

5）这就需要使用**载波延伸**（Carrier Extension）的办法，将**争用期增大为512字节的发送时间而保持最小帧长仍为64字节**

- 只要发送的MAC帧的长度不足512字节时，就在**MAC帧尾部填充一些特殊字符，使MAC帧的长度增大到512字节**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219162754.png)

6）在使用载波延伸的机制下，如果原本**发送的是大量的64字节长的短帧**，则**每一个短帧都会被填充448字节**的特殊字符，这样会**造成很大的开销**

7）因此，千兆以太网还使用了**分组突发**（Packet Bursting）功能。也就是当有**很多短帧要连续发送**时，**只将第一个短帧用载波延伸的方法进行填充**，而其后面的一系列短帧不用填充就可一个接一个地发送，它们之间只需空开必要的帧间最小间隔即可

- 这样就形成了一连串分组的突发，当累积发送1500字节或稍多一些为止

> 当千兆以太网工作在全双工方式时，不使用CSMA/CD协议，也不会使用载波延伸和分组突发

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219162937.png)

8）千兆以太网有多种不同的物理层标准：

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219163004.png)

### 3、10吉比特以太网

1）2002年6月，IEEE 802.3ae委员会通过**10吉比特以太网（10GE）**的正式标准，10GE也称为**万兆以太网**

2）万兆以太网并不是将千兆以太网的速率简单地提高了10倍。万兆以太网的目标是将以太网**从局域网范围**（校园网或企业网）**扩展到城域网与广域网**，成为城域网和广域网的主干网的主流技术之一

3）IEEE 802.3ae万兆以太网的主要特点有：

- 速率为10Gb/s
- 使用IEEE 802.3标准的帧格式（与10Mb/s、100Mb/s和1Gb/s以太网相同）
- 保留IEEE 802.3标准对以太网最小帧长和最大帧长的规定。这是为了用户升级以太网时，仍能和较低速率的以太网方便地通信
- 只工作在全双工方式而不存在争用媒体的问题，因此不需要使用CSMA/CD协议，这样传输距离就不再受碰撞检测的限制
- 增加了支持城域网和广域网的物理层标准

4）万兆以太网交换机常作为千兆以太网的**汇聚层交换机**，与千兆以太网交换机相连，还可以连接对传输速率要求极高的视频服务器、文件服务器等设备

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219163207.png)

5）万兆以太网有多种不同的物理层标准：

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219163228.png)

###4、 40/100吉比特以太网

1）2010年，IEEE发布了**40吉比特/100吉比特以太网**（40GE/100GE）的IEEE 802.3ba标准，40GE/100GE也称为**四万兆/十万兆以太网**

2）为了使**以太网**能够更高效、更经济地**满足局域网、城域网和广域网的不同应用需求**，IEEE 802.3ba标准定义了两种速率类型：

- 40Gb/s主要用于**计算应用**
- 100Gb/s主要用于**汇聚应用**

3）IEEE 802.3ba标准**只工作在全双工方式（不使用CSMA/CD协议）**，但仍**使用IEEE 802.3标准的帧格式**并遵守**最小帧长和最大帧长的规定**

4）IEEE 802.3ba标准的两种速率各有4种不同的传输媒体

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221219163411.png)



## 3.9 802.11 无线局域网

### 1、802.11无线局域网的组成

1）随着移动通信技术的发展，**无线局域网**（Wireless Local Area Network，**WLAN**）自20世纪80年代末以来逐步进入市场

2）IEEE于1997年制定出了无线局域网的协议标准802.11，**802.11无线局域网**是目前应用最广泛的无线局域网之一，人们更多地将其简称为**Wi-Fi**（Wireless Fidelity，无线保真度）

3）802.11无线局域网可分为以下两类：

- 有固定基础设施的
- 无固定基础设施的

4）**固定基础设施**是指预先建立的、能够覆盖一定地理范围的、**多个固定的通信基站**

5）802.11无线局域网使用最多的是它的固定基础设施的组网方式

**有固定基础设施的802.11无线局域网**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220111350.png)

> - 本BSS内各站点之间的通信以及与本BSS外的站点之间的通信，都必须经过本BSS内的AP进行转发
> - 网络管理员需要为AP分配一个最大32字节的服务集标识符（Service Set Identifier，SSID）和一个无线通信信道，SSID实际上就是使用该AP的802.11无线局域网的名字

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220111533.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220111604.png)

802.11标准并没有定义实现漫游的具体方法，仅定义了以下一些基本服务

1）**关联（Association）服务**

移动站与接入点AP建立关联的方法有以下两种：

- **被动扫描**
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220111759.png)
- **主动扫描**
  ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220111830.png)

2）**重建关联（Reassociation）服务和分离（Dissociation）服务**

如果一个移动站要把与某个接入点AP的关联转移到另一个AP，就可以使用重建关联服务；若要终止关联服务，就应使用分离服务。



**无固定基础设施的802.11无线局域网**
**自组织网络（ad hoc Network)**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220112017.png)

> - 转发站需要具备路由功能
> - 自组织网络组网方便，不需要基站，并且具有非常好的生存性，这使得自组织网络在**军用**和**民用**领域都有很好的应用前景
> - 802.11无线局域网的ad hoc模式允许网络中的各站点在其通信范围内直接通信，也就是**支持站点间的单跳通信**，而标准中**并没有包括多跳路由功能**。因此，802.11无线局域网的ad hoc模式应用较少

### 2、802.11无线局域网的物理层

1）802.11无线局域网的物理层非常复杂，依据**工作频段、调制方式、传输速率**等，可将其分为多种物理层标准：
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220112612.png)

2）802.11无线网卡一般会被做成**多模**的，以便能适应多种不同的物理层标准，例如支持802.11b/g/n

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220112637.png)

3）无线局域网最初还使用红外技术（infrared，IR）和跳频扩频（Frequency Hopping Spread Spectrum，**FHSS**）技术，但目前已经很少使用了

4）**跳频技术**的发明人，是好莱坞黄金时代的著名女星**海蒂·拉玛**，跳频技术为CDMA和Wi-Fi等无线通信技术奠定了基础。因此，海蒂·拉玛被誉为“**Wi-Fi之母**”

5）最近几年，802.11无线局域网又有一些新的物理层标准陆续推出：

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220112744.png)

### 3、802.11无线局域网使用CSMA/CA协议的原因

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220145239.png)

1）对于802.11无线局域网，其使用无线信道传输数据，这与共享总线以太网使用有线**传输介质不同**。因此，802.11无线局域网**不能简单照搬**共享总线以太网使用的**CSMA/CD协议**。

2）802.11无线局域网采用了另一种称为CSMA/CA的协议，也就是**载波监听多址接入/碰撞避免**（Carrier Sense Multiple Access/Collision Avoidance，**CSMA/CA**）

3）CSMA/CA协议**仍然采用**CSMA/CD协议中的**CSMA**，以“先听后说”的方式来减少碰撞的发生，但是**将“碰撞检测CD”改为了“碰撞避免CA”**

> 尽管CA表示碰撞避免，但并不能避免所有的碰撞，而是尽量减少碰撞发生的概率。

4）802.11无线局域网不采用“碰撞检测CD”的原因如下：

-  由于**无线信道的传输环境复杂**且信号强度的动态范围非常大，在802.11无线网卡上**接收到的信号强度一般都远远小于发送信号的强度**，信号强度甚至相差百万倍。因此，**如果要在802.11无线网卡上实现碰撞检测，对硬件的要求非常高**
- 即使能够在硬件上实现碰撞检测功能，但由于无线电波传播的特殊性（**存在隐蔽站问题**），**还会出现无法检测到碰撞的情况**，因此实现**碰撞检测并没有意义**

**无线局域网的隐蔽站问题（Hidden Station Problem）**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220145620.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220145900.png)

> 无线局域网不能简单照搬共享总线以太网（有线局域网）使用的CSMA/CD协议，而是不再实现碰撞检测CD功能，但在CSMA的基础上增加碰撞避免CA功能，即使用CSMA/CA协议。

### 4、CSMA/CD协议的基本工作原理

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150136.png)

> - DCF帧间间隔DIFS的长度为128μs，在DCF方式中，DIFS用来发送数据帧和管理帧
> - DCF是分布式协调功能（Distributed Coordination Function，DCF）的英文缩写词。在DCF方式下，没有中心控制站点，每个站点使用CSMA/CA协议通过争用信道来获取发送权。DCF方式是802.11定义的默认方式（必须实现）
> - 等待DIFS间隔是考虑到可能有其他的站有高优先级的帧要发送

**虚拟载波监听（Virtual Carrier Sense）机制**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150252.png)

> - 短帧间间隔（Short Interframe Space，SIFS）的长度为28μs，它是最短的帧间间隔，用来分隔开属于一次对话的各帧。一个站点应当能够在这段时间内从发送方式切换到接收方式。使用SIFS的帧类型有ACK帧、CTS帧等
> - ACK:由于无线信道的误码率较高，CSMA/CA协议还需要使用停止-等待的确认机制来实现可靠传输，这与使用CSMA/CD协议的共享式以太网不同。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150417.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150450.png)

> - 随机退避时间： 当某个站在发送帧时，很可能有多个站都在监听信道并等待发送帧，一旦信道空闲，这些站几乎同时发送帧而产生碰撞。为了避免上述情况，所有要发送帧的站检测到信道从忙转为空闲后，都要执行退避算法。这样不仅可以减少发生碰撞的概率，还可避免某个站长时间占用无线信道。
> - 当某个站要发送数据帧时，仅在这种情况下才不使用退避算法：检测到信道空闲，并且该数据帧不是成功发送完上一个数据帧之后立即连续发送的数据帧。除此之外的以下情况，都必须使用退避算法：
>   - 在发送帧之前检测到信道处于忙态
>   - 在每一次重传一个帧时
>   - 在每一次成功发送帧后要连续发送下一个帧时

**CSMA/CA协议的退避算法**

1）在执行退避算法时，站点为退避计时器设置一个随机的退避时间：

- 当退避计时器的时间减小到零时，就开始发送数据；
- 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就**冻结**退避计时器的数值，重新等待信道变为空闲，再经过帧间间隔DIFS后，继续启动退避计时器。

2）在进行第i次退避时，退避时间在时隙编号{0，1，… ，2^2+i−1}中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。当时隙编号达到255时（对应于第6次退避）就不再增加了。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150734.png)

**为了进一步降低发生碰撞的概率，802.11无线局域网允许源站对信道进行预约。**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220150959.png)

> - RTS（Request To Send）帧是短的控制帧，它包括源地址、目的地址和本次通信（包括目的站发回确认帧所需的时间）所需的持续时间。
> - CTS（Clear To Send）帧是短的响应控制帧，它也包括本次通信所需的持续时间（从RTS帧中将此持续时间复制到CTS帧中）。
> - NAV（信道忙）：除源站和目的站的其他各站，在收到CTS帧或数据帧后就推迟访问信道。这样就确保了源站和目的站之间的通信不会受到其他站的干扰
> - 若RTS帧发生碰撞，源站就不可能收到CTS帧，源站会执行退避算法重传RTS帧。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151136.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151156.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151215.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151236.png)



**为了进一步降低发生碰撞的概率，802.11无线局域网允许源站对信道进行预约。**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151317.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151336.png)



![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151402.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151421.png)



### 3、802.11无线局域网的MAC帧

1）**数据帧**

- 用于站点间传输数据

2）**控制帧**

- 通常与数据帧搭配使用
- 负责区域的清空、虚拟载波监听的维护以及信道的接，并于收到数据帧时予以确认
- ACK帧、RTS帧以及CTS帧等都属于控制帧

3）**管理帧**

- 用于加入或退出无线网络，以及处理AP之间连接的转移事宜
- 信标帧、关联请求帧以及身份认证帧等都属于管理帧

**802.11无线局域网的数据帧格式**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151843.png)

> - 持续期：用于实现CSMA/CA的虚拟载波监听和信道预约机制。在数据帧、RTS帧和CTS帧中用该字段指出将要持续占用信道的时长。
>
> - 序号控制：用来实现802.11的可靠传输，对数据帧进行编号。
>
> - ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151937.png)
>
> - ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220151958.png)
>   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152041.png)
>   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152058.png)
>
>   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152116.png)
>   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152139.png)
>
>   ![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152156.png)



![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221220152220.png)
