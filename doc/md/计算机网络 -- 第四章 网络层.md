[toc]

# 计算机网络 -- 第四章 网络层

## 4.1 网络层概述

### 1、分组转发呵路由选择

1）网络层的主要任务就是将**分组从源主机经过多个网络和多段链路传输到目的主机**，可以将该任务划分为**分组转发**和**路由选择**两种重要的功能。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222172836.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222172914.png)

> R1如何知道应从自己的哪个接口转发分组?  ==> 查转发表

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222173009.png)

### 2、网络层向其上层提供的两种服务

- 面向连接的虚电路服务
- 无连接的数据报服务

**面向连接的虚电路服务**

1）核心思想是“**可靠通信应由网络自身来保证**”

2）必须首先**建立网络层连接** —— **虚电路**（Virtual Circuit，**VC**），以保证通信双方所需的一切网络资源。

3）通信双方**沿着已建立的虚电路发送分组**。

4）通信结束后，需要**释放**之前所建立的虚电路。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222173300.png)

> - 虚电路表示这是一条逻辑上的连接，分组沿着这条逻辑连接按照存储转发方式传送，而不是真正建立了一条物理连接。
> - 而采用电路交换的电话通信，则是先建立一条真正的物理连接。因此，分组交换的虚连接与电路交换的连接只是类似，但并不完全一样。
> - 分组的首部仅在连接建立阶段使用完整的目的主机地址，之后每个分组的首部只需要携带一条虚电路编号即可。
>
> ​       这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确（无差错按序到达、不丢失、不重复）到达接收方。
>
> ​       很多广域分组交换网都使用面向连接的虚电路服务。例如，曾经的X.25和逐渐过时的帧中继（Frame Relay，FR）、异步传输模式（Asynchronnous Transfer Mode，ATM）。
>
> *然而，因特网的先驱者并没有采用这种设计思想，而是采用了无连接的数据报服务。*

**无连接的数据报服务**

1）核心思想是“**可靠通信应由用户主机来保证**”。

2）**不需要建立网络层连接**。

3）**每个分组可走不同的路径**。因此，每个分组的首部都必须携带目的主机的完整地址。

4）通信结束后，**没有需要释放的连接**。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222173540.png)

> 这种通信方式所传送的分组可能误码、丢失、重复和失序。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222173616.png)

> 另外，这种设计思想的运行方式灵活、能够适应多种应用。因特网能够发展到今日的规模，充分证明了当初采取这种设计思想的正确性。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222173652.png)

## 4.2 网际协议（IP）

### 4.2.1 异构网络互连

#### 1、网际协议IP

1）网际协议（Internet Protocol，**IP**）是TCP/IP体系结构**网际层中的核心协议**。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222192834.png)

#### 2、异构网络互连

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222192920.png)

> 这些网络的拓扑、性能以及所使用的网络协议都不尽相同，这是由用户需求的多样性造成的，没有一种单一的网络能够适应所有用户的需求。
>
> 要将众多的异构型网络都互连起来，并且能够互相通信，则会面临许多需要解决的问题。
>
> - 不同的网络接入机制
> - 不同的差错恢复方法
> - 不同的路由选择技术
> - 不同的寻址方案
> - 不同的最大分组长度
> - 不同的服务（面向连接服务和无连接服务）

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222193432.png)

> 当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，它们看不见互连的各网络的具体异构细节。

### 4.2.2 IPv4地址及其编址方式

#### 1、IPv4地址概述

1）IPv4地址是给因特网（Internet）上的**每一个主机（或路由器）的每一个接口**分配的一个在全世界范围内**唯一的32比特的标识符**。

2）IPv4地址由**因特网名字和数字分配机构**（Internet Corporation for Assigned Names and Numbers，**ICANN**）进行分配。

- 我国用户可向**亚太网络信息中心**（Asia Pacific Network Information Center，**APNIC**）申请IP地址，需要缴纳相应的费用，一般不接受个人申请。
- **2011年2月3日**，因特网号码分配管理局（Internet Assigned Numbers Authority，IANA）（由ICANN行使职能）宣布，**IPv4地址已经分配完毕**。
- 我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222193653.png)

3）**IPv4地址的编址方式**经历了三个历史阶段

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222193756.png)

#### 2、IPv4地址的表示方法

1）由于IPv4地址由32比特构成，不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制表示方法**以方便用户使用。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222193855.png)

#### 3、IPv4地址的分类编制方法

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222193949.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194016.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194044.png)

1）**A类**、**B类**和**C类**地址都是**单播地址**，只有单播地址可以**分配给网络中的主机（或路由器）的各接口**

2）**主机号为“全0”**的地址是**网络地址**，**不能分配**给主机（或路由器）的各接口。

3）**主机号为“全1”**的地址是**广播地址**，**不能分配**给主机（或路由器）的各接口。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194240.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194307.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194326.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194352.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194427.png)

4）一般不使用的特殊IPv4地址

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194456.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194540.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194607.png)

#### 4、IPv4地址的划分子网编址方法

1）随着更多的中小网络加入因特网，**IPv4分类编址方法不够灵活、容易造成大量IPv4地址资源浪费**的缺点就暴露出来了。

【举例】分类编址方法不够灵活且容易造成大量地址浪费，划分子网编址方法对其进行改进（“打补丁”）

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194809.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194838.png)

> 申请新的网络号存在一下弊端：
>
> - 需要等待很长的时间，并且要花费更多的费用。
> - 即便申请到了两个新的网络号，其他路由器的路由表还需要新增针对这两个新的网络的路由条目。
> - 浪费原来已申请到的B类网络中剩余的大量地址。
>
>  如果可以从IPv4地址的主机号部分借用一些比特作为子网号来区分不同的子网，就可以利用原有网络中剩余的大量IPv4地址，而不用申请新的网络地址了。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222194943.png)

*如果未在图中标记子网号部分，那么我们或计算机又如何知道在分类地址中，主机号有多少比特被借用作为子网号了呢？*

2）**子网掩码**可以表明分类IPv4地址的主机号部分被借用了几个比特作为子网号

3）与IPv4地址类似，子网掩码也是由**32比特**构成的。

- 用左起多个**连续的比特1**对应IPv4地址中的**网络号和子网号**；
- 之后的多个**连续的比特0**对应IPv4地址中的**主机号**。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195130.png)

4）将划分子网的**IPv4地址与相应的子网掩码**进行逐比特的**逻辑与运算**，就可**得到**该IPv4地址所在**子网的网络地址**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195209.png)

> 只要给定了一个分类的IPv4地址及其相应的子网掩码，就可以得出**子网划分的全部细节**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195311.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195332.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195347.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195435.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195451.png)

5）**默认子网掩码**是指在**未划分子网的情况下使用的子网掩码**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195538.png)

#### 5、IPv4地址的无分类编制方法

1）IPv4地址的划分子网编址方法在一定程度上缓解了因特网在发展中遇到的困难，但是**数量巨大的C类网**(2^24−3^=2097152)由于其**每个网络所包含的地址数量太小**(2^8^=256)，因此**并没有得到充分使用**，而因特网的IPv4地址仍在加速消耗，整个**IPv4地址空间面临全部耗尽的威胁**。

2）为此，因特网工程任务组IETF又提出了采用**无分类编址**的方法，来解决IPv4地址资源紧张的问题，同时还专门成立IPv6工作组负责研究新版本的IP，以彻底解决IPv4地址耗尽问题。

3）1993年，因特网工程任务组IETF发布了**无分类域间路由选择**（Classless Inter-Domain Routing，**CIDR** ）的RFC文档[RFC1517~1519，RFC1520]。

- **CIDR消除了传统A类、B类和C类地址以及划分子网的概念。**
- **CIDR可以更加有效地分配IPv4地址资源，并且可以在IPv6使用之前允许因特网的规模继续增长。**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222195852.png)

4）无分类编址方法使用的**地址掩码**与划分子网使用的**子网掩码**类似，由32比特构成。

- 用左起多个**连续的比特1**对应IPv4地址中的**网络前缀**；
- 之后的多个**连续的比特0**对应IPv4地址中的**主机号**。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200007.png)

5）为了简便起见，可以不明确给出配套的地址掩码的点分十进制形式，而是在无分类编址的IPv4地址后面加上斜线“/”，在斜线之后写上网络前缀所占的比特数量（也就是地址掩码中左起连续比特1的数量），这种记法称为**斜线记法**。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200030.png)

6）实际上，无分类域间路由选择CIDR是将网络前缀都相同的、连续的多个无分类IPv4地址，组成一个**CIDR地址块**，只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的以下全部细节：

- 地址块中的**最小地址**
- 地址块中的**最大地址**
- 地址块中的**地址数量**
- 地址块中的**聚合某类网络（A类、B类、C类）的数量**
- **地址掩码**

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200228.png)

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200243.png)

7）使用无分类编址方法，可以根据客户的需要**分配适当大小的CIDR地址块**，因此可以更加有效地分配IPv4的地址空间。

> 分类编址方法
>
> 只能以/8（A类网络）、/16（B类网络）或/24（C类网络）为单位来分配，既不灵活，也容易造成IPv4地址的浪费。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200350.png)

8）使用无分类编址方法的另一个好处是**路由聚合**（也称为**构造超网**）。

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/20221222200502.png)

![image-20221222200710920](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222200710920.png)

7）**网络前缀越长，地址块越小，路由越具体**

8）若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为**最长前缀匹配**，因为这样的路由更具体。

![image-20221222201007342](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201007342.png)

![image-20221222201021766](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201021766.png)

![image-20221222201044566](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201044566.png)

![image-20221222201059736](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201059736.png)

![image-20221222201111320](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201111320.png)

![image-20221222201129312](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221222201129312.png)

### 4.2.3 IPv4地址的应用规划

1）IPv4地址的应用规划是指将给定的IPv4地址块（或分类网络）划分成若干个更小的地址块（或子网），并将这些地址块（或子网）分配给互联网中的不同网络，进而可以给各网络中的主机和路由器的接口分配IPv4地址

![image-20221223201250387](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201250387.png)

**使用定长子网掩码划分子网**

【举例】假设申请到的C类网络为218.75.230.0，使用定长的子网掩码给下图所示的小型互联网中的各设备分配
IPv4地址。

![image-20221223201400321](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201400321.png)

![image-20221223201507419](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201507419.png)

![image-20221223201524675](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201524675.png)

![image-20221223201613493](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201613493.png)

**使用变长子网掩码划分子网**

【举例】假设申请到的地址块为218.75.230.0/24，使用变长的子网掩码给下图所示的小型互联网中的各设备分
配IPv4地址。

![image-20221223201801633](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201801633.png)

> 在地址块中选取子块的原则：**每个子块的起点位置不能随便选取，只能选取主机号部分是块大小整数倍的地址作为起点。**
>
> 建议先为大的子块选取

![image-20221223201922363](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223201922363.png)

> 若先为小的子块选取：
>
> ![image-20221223202003442](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223202003442.png)

![image-20221223202204639](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223202204639.png)

![image-20221223202217331](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223202217331.png)

### 4.2.4 IPv4地址与MAC地址

#### 1、IPv4地址与MAC地址的封装位置

![image-20221223202303786](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223202303786.png)

#### 2、数据报传送过程中IPv4地址与MAC地址的变化情况

![image-20221223202417933](E:/MyFile/TyporaImgs/image-20221223202417933.png)

1）在数据包的传送过程中，数据包的**源IP地址和目的IP地址保持不变**；

2）在数据包的传送过程中，数据包的**源MAC地址和目的MAC地址逐链路（或逐网络）改变**。

![image-20221223202528751](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223202528751.png)

#### 3、IPv4地址与MAC地址的关系

1）如果仅使用MAC地址进行通信，则会出现以下主要问题：

- 因特网中的每台路由器的**路由表**中就必须**记录**因特网上**所有主机和路由器各接口的MAC地址**。
- 手工给各路由器配置路由表几乎是不可能完成的任务，即使使用路由协议让路由器通过相互交换路由信息来自动构建路由表，也会因为**路由信息需要包含海量的MAC地址信息而严重占用通信资源**。
- **包含海量MAC地址的路由信息需要路由器具备极大的存储空间**，并且会给分组的**查表转发带来非常大的时延**。

2）因特网的网际层**使用IP地址进行寻址**，就可使因特网中各**路由器**的路由表中的路由记录的数量大大减少，因为**只需记录部分网络的网络地址**，而不是记录每个网络中各通信设备的各接口的MAC地址。

- 路由器收到IP数据报后，根据其首部中的目的IP地址的网络号部分，基于自己的路由表进行查表转发。

> 查表转发的结果可以指明IP数据报的下一跳路由器的IP地址，但无法指明该IP地址所对应的MAC地址。因此，在数据链路层封装该IP数据报成为帧时，帧首部中的目的MAC地址字段就无法填写，该问题需要使用网际层中的**地址解析协议ARP**来解决。

### 4.2.5 地址解析协议

![image-20221223203410734](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203410734.png)

![image-20221223203421928](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203421928.png)

![image-20221223203438465](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203438465.png)

![image-20221223203453597](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203453597.png)

![image-20221223203508241](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203508241.png)

![image-20221223203523180](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203523180.png)

> 通过ARP自动获取，生命周期默认为两分钟。
>
> 手工配置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效。

> ​        好不容易通过ARP获取来的IP地址与MAC地址的对应关系记录，为什么要周期性删除呢？
>
> ![image-20221223203654381](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203654381.png)

**ARP不能跨网络使用**

![image-20221223203745319](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223203745319.png)

1）ARP协议的相关注意事项：

- 由于ARP协议的主要用途是从网际层使用的IP地址解析出在数据链路层使用的MAC地址。因此，有的教材将ARP协议划归在**网际层**，而有的教材将ARP协议划归在**数据链路层**。这两种做法都是可以的。
- 除了此处介绍的ARP请求报文和响应报文，**ARP协议还有其他类型的报文**，例如用于检查IP地址冲突的“无故ARP”（Gratuitous ARP）。
- 由于ARP协议很早就制定出来了（1982年11月），当时并没有考虑网络安全问题。因此，ARP协议没有安全验证机制，存在**ARP欺骗和攻击**等问题。

### 4.2.6 IP数据报的发送和转发流程

1）IP数据报的发送和转发过程包含以下两个过程：

- **主机**发送IP数据报
- **路由器**转发IP数据报

![image-20221223204105546](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204105546.png)

![image-20221223204133008](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204133008.png)

![image-20221223204159960](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204159960.png)

> 交给哪个路由器来转发呢？

![image-20221223204240824](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204240824.png)

![image-20221223204302146](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204302146.png)

![image-20221223204316339](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204316339.png)

![image-20221223204328908](E:/MyFile/TyporaImgs/image-20221223204328908.png)

![image-20221223204349051](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204349051.png)



![image-20221223204433397](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204433397.png)

![image-20221223204458790](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204458790.png)

![image-20221223204512240](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204512240.png)

### 4.2.7 IPv4数据报的首部格式

1）IPv4数据报的首部格式及其内容是**实现IPv4协议各种功能的基础**。

2）在TCP/IP标准中，各种数据格式常常**以32比特（即4字节）为单位**来描述。

3）固定部分是指**每个IPv4数据报都必须要包含的部分**。

4）某些IPv4数据报的首部，除了包含20字节的固定部分，还包含一些可选的字段来**增加IPv4数据报的功能**。

5）IPv4数据报首部中的各字段或某些字段的组合，用来表达IPv4协议的相关功能。

![image-20221223204808347](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223204808347.png)

1）**版本**：

- 长度为4个比特，用来表示IP协议的版本。
- **通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议的版本号为4（即IPv4）。**

2）**首部长度**

- 长度为4个比特，该字段的取值**以4字节为单位**，用来表示IPv4数据报的首部长度。
- **最小取值**为二进制的0101，即十进制的5，再乘以4字节单位，**表示IPv4数据报首部只有20字节固定部分**。
- **最大取值**为二进制的1111，即十进制的15，再乘以4字节单位，**表示IPv4数据报首部包含20字节固定部分和最大40字节可变部分**。

3）**可选字段**

- 长度从1字节到40字节不等，用来支持排错、测量以及安全措施等功能。

- 虽然可选字段增加了IPv4数据报的功能，但这同时也使得IPv4数据报的首部长度成为可变的，这就增加了因特网中每一个路由器处理IPv4数据报的开销。

- 实际上，可选字段很少被使用。

  

4）**填充**

- **用来确保IPv4数据报的首部长度是4字节的整数倍**，使用全0进行填充
- 当首部长度（20字节固定部分+可变部分）的长度不是4字节整数倍时，填充相应数量的全0字节，以确保IPv4数据报的首部长度是4字节的整数倍。

5）**区分服务**

- 长度为8个比特，用来获得更好的服务。
- 该字段在旧标准中叫作服务类型，但实际上一直没有被使用过。
- 1998年，因特网工程任务组IETF把这个字段改名为区分服务。
- 利用该字段的不同取值可提供不同等级的服务质量。
- 只有在使用区分服务时该字段才起作用，一般情况下都不使用该字段。

6）**总长度**

- 长度为16个比特，该字段的取值**以字节为单位**，用来表示**IPv4数据报的长度（首部长度+数据载荷长度）**。
- 最大取值为二进制的16个比特1，即十进制的65535（很少传输这么长的IPv4数据报）。

![image-20221223205334045](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223205334045.png)

![image-20221223205409327](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223205409327.png)

**IPv4数据报分片的概念**

![image-20221223205441950](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223205441950.png)

7）**标识**

- 长度为16个比特，属于同一个IPv4数据报的**各分片数据报应该具有相同的标识**。
- IP软件会维持一个计数器，每产生一个IPv4数据报，计数器值就加1，并将此值赋给标识字段。

8）**标志**

- 最低位（More Fragment，**MF**）
  - MF=1表示本分片**后面还有分片**
  - MF=0表示本分片**后面没有分片**
- 中间位（Don’t Fragment，**DF**）
  - DF=1表示**不允许分片**
  - DF=0表示**允许分片**
- 最高位为保留位，必须设置为0

9）**片偏移**

- 长度为13个比特，该字段的取值
- **以8字节为单位**，用来指出分片IPv4数据报的**数据载荷偏移其在原IPv4数据报的位置有多远。**

![image-20221223205732604](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223205732604.png)

![image-20221223205952205](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223205952205.png)

![image-20221223210004756](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210004756.png)

![image-20221223210017453](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210017453.png)

10）**生存时间（Time To Live，TTL）**

- 长度为8个比特，最大取值为二进制的11111111，即十进制的255。该字段的取值最初以秒为单位。因此，IPv4数据报的最大生存时间最初为255秒。路由器转发IPv4数据报时，将其首部中该字段的值减去该数据报在路由器上所耗费的时间，若结果不为0就转发，否则就丢弃。
- 生存时间字段后来改为以“**跳数**”为单位，**路由器收到待转发的IPv4数据报时，将其首部中的该字段的值减1，若结果不为0就转发，否则就丢弃**。

![image-20221223210122106](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210122106.png)

11）**协议**

- 长度为8个比特，用来指明IPv4数据报的**数据载荷是何种协议数据单元PDU**。

![image-20221223210148231](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210148231.png)

![image-20221223210201581](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210201581.png)

12）**首部校验和**

- 长度为16个比特，用于检测IPv4数据报在传输过程中其**首部是否出现了差错**。
- IPv4数据报每经过一个路由器，其首部中的某些字段的值（例如生存时间TTL、标志以及片偏移等）都可能发生变化，因此**路由器都要重新计算一下首部检验和**。

**首部校验和的计算方法**

![image-20221223210305946](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210305946.png)

![image-20221223210320098](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221223210320098.png)

> ​         上述检验和的计算方法不仅用于IP协议，还用于运输层的用户数据报协议UDP和传输控制协议TCP，常被称为**因特网检验和**（Internet Checksum）。这种检验和的检错性能虽然不如CRC，但更易用软件实现。

**首部校验和计算的重点在于二进制反码求和的运算**

**两个数**进行二进制反码求和的运算规则是从低位到高位逐列进行计算：

- 0和0相加是0

- 0和1相加是1

- 1和1相加是0，但要产生一个进位1，加到下一列

- 若最高位相加后产生进位，则最后得到的结果要加1

  

> 由于网际层并不向其高层提供可靠传输的服务，并且计算首部检验和是一项耗时的操作，因此在IPv6中，路由器不再计算首部检验和，从而更快转发IP数据报。

13）**源IP地址**

- 长度为32个比特，用来填写发送IPv4数据报的源主机的IPv4地址。

14）**目的IP地址**

- 长度为32个比特，用来填写接收IPv4数据报的目的主机的IPv4地址。

## 4.3 静态路由配置

1）静态路由配置是指用户或网络运维人员使用路由器的相关命令给路由器**人工配置路由表**。

- 人工配置方式**简单、开销小**、但**不能及时适应网络状态（流量、拓扑等）的变化**，一般只在小规模网络中采用。

![image-20221224183823045](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224183823045.png)

![image-20221224183855457](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224183855457.png)

![image-20221224183907998](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224183907998.png)

*需要针对因特网中的每一个网络给R1添加一条相应的路由条目吗？*

2）**默认路由**

![image-20221224183954370](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224183954370.png)

> 默认路由条目中的目的网络0.0.0.0/0，其中0.0.0.0表示任意网络，而网络前缀“/0”（相应的地址掩码为0.0.0.0）是最短的网络前缀。
>
> 路由器在查找转发表转发IP数据报时，遵循“最长前缀匹配”的原则，因此**默认路由条目的匹配优先级最低**。

3）**特定主机路由**

出于某种安全问题的考虑，同时为了使网络运维人员更方便地控制网络和测试网络，特别是在对网络的连接或路由表进行排错时，指明到某一台主机的特定主机路由是十分有用的。

![image-20221224184106345](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224184106345.png)

> 特定主机路由条目中的目的网络192.168.2.1/32，其中192.168.2.1是特定主机的IP地址，而网络前缀“/32”（相应地址掩码为255.255.255.255）是最长的网络前缀。
>
> 路由器在查找转发表转发IP数据报时，遵循“最长前缀匹配”的原则，因此**特定主机路由条目的匹配优先级最高**。
>
> ![image-20221224184155563](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224184155563.png)

4）进行静态路由配置需要认真考虑和谨慎操作，否则可能出现以下问题：

- 路由条目**配置错误**，甚至导致出现**路由环路**。
- 聚合路由条目时可能**引入不存在的网络**。

## 4.4 因特网的路由选择协议

### 4.4.1 路由选择分类

![image-20221224184344998](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224184344998.png)

1）因特网是全球最大的互联网，它所采取的路由选择协议具有以下三个主要特点：

- **自适应**：因特网采用**动态路由**选择，能较好地适应网络状态的变化。
- **分布式**：因特网中的**各路由器**通过相互间的信息交互，**共同完成路由信息的获取和更新**。
- **分层次**：将整个因特网划分为许多较小的**自治系统**（Autonomous System，**AS**）。在自治系统内部和外部采用不同类别的路由选择协议，分别进行路由选择。

### 4.4.2 因特网采用分层次的路由选择协议

![image-20221224184541650](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224184541650.png)

1）域内路由选择：

- 内部网关协议**IGP**，
  - 例如：RIP
  - 例如：OSRF

2）域间路由选择

- 外部网关协议**EGP**
  - 例如：BGP

> 注意：
>
> - 外部网关协议EGP和内部网关协议IGP只是路由选择协议的分类名称，而不是具体的路由选择协议。
> - 外部网关协议和内部网关协议名称中使用的是“网关”这个名词，是因为在因特网早期的RFC文档中，没有使用“路由器”而使用的是“网关”这一名词。

### 4.4.3 路由信息协议

#### 1、路由信息协议RIP的相关基本概念

1）路由信息协议（Routing Information Protocol，**RIP**）是内部网关协议中最先得到广泛使用的协议之一，其相关标准文档为[RFC 1058]。

2）RIP要求自治系统AS内的每一个路由器，都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为**距离向量**（Distance-Vector，**D-V**）。

3）RIP使用**跳数**（Hop Count）作为度量（Metric）来衡量到达目的网络的**距离**。

- RIP将路由器**到直连网络**的**距离定义为1**。
- RIP将路由器**到非直连网络**的**距离定义为所经过的路由器数加1**。
- RIP允许一条路径最多只能包含15个路由器，**距离等于16时相当于不可达**。因此**RIP只适用于小型互联网**。

![image-20221224185208133](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185208133.png)

> 有些厂商的路由器并没有严格按照RIP标准文档的规定来实现RIP。例如，思科路由器中的RIP，将路由器到直连网络的距离定义为0，但这并不影响RIP的正常运行。

4）RIP认为**好的路由**就是“距离短”的路由，也就是所**通过路由器数量最少的路由**。

![image-20221224185347361](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185347361.png)

5）当到达同一目的网络有多条RIP距离相等的路由时，可以进行**等价负载均衡**，也就是将通信量均衡地分布到多条等价的路径上。

![image-20221224185409002](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185409002.png)

6）RIP具有以下三个重要特点

- 和谁交换信息：仅和**相邻路由器**交换信息

  ![image-20221224185521925](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185521925.png)

- 交换什么信息：路由器自己的**路由表**，即本路由器到所在自治系统AS中各网络的最短RIP距离，以及到各网络应经过的下一跳路由器。

- 何时交换信息：**周期性交换**（例如：每个30s），为了加快RIP的收敛速度，当网络拓扑发生变化时，路由器要及时向相邻路由器通告拓扑变化后的路由信息，这称为**触发更新**。

  

#### 2、RIP的基本工作过程

![image-20221224185711681](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185711681.png)

1）路由器刚开始工作时，**只知道自己到直连网络的RIP距离为1**。

2）每个路由器**仅和相邻路由器周期性地交换并更新路由信息**。

3）若干次交换和更新后，**每个路由器都知道到达本自治系统AS内各网络的最短距离和下一跳路由器**，称为**收敛**。

#### 3、RIP的距离向量算法

![image-20221224185900380](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185900380.png)

![image-20221224185918526](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185918526.png)

![image-20221224185955935](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224185955935.png)

![image-20221224190010103](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190010103.png)

![image-20221224190023136](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190023136.png)

![image-20221224190036689](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190036689.png)

![image-20221224190047218](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190047218.png)

1）除了上述RIP路由条目更新规则，在RIP的距离向量算法中还包含以下一些时间参数：

- 路由器每隔**大约30秒**向其所有相邻路由器发送路由更新报文。
- 若**180秒**（默认）没有收到某条路由条目的更新报文，则把该路由条目标记为无效（即把RIP距离设置为16，表示不可达），若再过一段时间（如120秒），还没有收到该路由条目的更新报文，则将该路由条目从路由表中删除。

![image-20221224190135130](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190135130.png)

![image-20221224190200292](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190200292.png)

#### 4、RIP存在的问题

**坏消息传播很慢**

![image-20221224190247701](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190247701.png)

![image-20221224190259476](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190259476.png)

1）“坏消息传播得慢”的问题又被称为路由环路或**RIP距离无穷计数问题**。这是距离向量算法的一个固有问题。可以采取以下多种措施**减少**出现该问题的概率或减小该问题带来的危害：

- 限制**最大RIP距离为15**（16表示不可达）。
- 当路由表发生变化时就立即发送路由更新报文（即“**触发更新**”），而不仅是周期性发送。
- 让路由器记录收到某个特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即“**水平分割**”）。

> 使用上述措施仍无法彻底解决问题。因为在距离向量算法中，每个路由器都缺少到目的网络整个路径的完整信息，无法判断所选的路由是否出现了环路。

#### 5、RIP版本和相关报文的封装

1）现在较新的RIP版本是1998年11月公布的**RIP2**[RFC 2453]，已经成为因特网标准协议。与RIP1相比，RIP2可以支持**变长子网掩码和CIDR**。另外，RIP2还提供**简单的鉴别**过程并支持**多播**

2）RIP相关报文使用运输层的用户数据报协议UDP进行封装，使用的**UDP端口号为520**

- 从**RIP报文封装**的角度看，RIP属于TCP/IP体系结构的**应用层**。
- 但RIP的核心功能是**路由选择**，这属于TCP/IP体系结构的**网际层**

#### 6、RIP的优缺点

![image-20221224190544750](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190544750.png)

### 4.4.4 开放最短路径优先协议

#### 1、开放最短路径优先OSPF的相关基本概念

1）开放最短路径优先（Open Shortest Path First，**OSPF**）协议是为了**克服路由信息协议RIP的缺点**在1989年开发出来的

- “**开放**”表明OSPF协议不是受某一厂商控制，而是**公开发表**的。
- “**最短路径优先**”是因为使用了Dijkstra提出的**最短路径算法**（Shortest Path First，**SPF**）。

> 注意：
>
> “开放最短路径优先”只是一个路由选择协议的名称，但这并不表示其他的路由选择协议不是“最短路径优先”。实际上，用于自治系统AS内部的各种路由选择协议（例如RIP），都要寻找一条“最短”的路径。

2）OSPF是基于**链路状态**的，而不像RIP是基于距离向量的。

3）OSPF基于链路状态并采用最短路径算法计算路由，从算法上保证了**不会产生路由环路**。

4）OSPF**不限制网络规模，更新效率高，收敛速度快**。

**链路状态**

1）链路状态（Link State，LS）是指本路由器都和**哪些路由器相邻**，以及**相应链路的“代价（cost）**”。

- “**代价**”用来表示费用、距离、时延和带宽等，这些都由网络管理人员来决定。

  ![image-20221224190849097](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224190849097.png)

**OSPF路由器邻居关系的建立和维护**

1）OSPF相邻路由器之间通过交互**问候（Hello）分组**来建立和维护**邻居关系**。

- 问候（Hello）分组封装在**IP数据报**中，发往**组播地址224.0.0.5**。IP数据报首部中的**协议号**字段的取值为**89**，表明IP数据报的数据载荷为OSPF分组。

  ![image-20221224191024851](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191024851.png)

- 问候（Hello）分组的**发送周期为10秒**

- 若**40秒**未收到来自邻居路由器的问候（Hello）分组，
  则认为邻居路由器不可达。

- 每个路由器都会建立一张**邻居表**。

  ![image-20221224191117543](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191117543.png)

**链路状态通告**

1）使用OSPF的每个路由器都会产生**链路状态通告**（Link State Advertisement，**LSA**）。

2）LSA中包含以下两类链路状态信息：

- **直连网络**的链路状态信息
- **邻居路由器**的链路状态信息

![image-20221224191235303](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191235303.png)

**链路状态更新分组**

1）链路状态通告LSA被封装在**链路状态更新**（Link State Update，LSU）分组中，采用**可靠的洪泛法**（Flooding）进行发送。

- 洪泛法的要点是路由器**向自己所有的邻居路由器发送链路状态更新分组**，收到该分组的各路由器又将该分组转发给自己所有的邻居路由器（但其上游路由器除外），以此类推。
- 可靠是指收到链路状态更新分组后要发送确认，**收到重复的更新分组无需再次转发**，但要发送一次确认。

![image-20221224191339065](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191339065.png)

**链路状态数据库**

1）使用OSPF的每一个路由器都有一个**链路状态数据库**（Link State Database，**LSDB**），用于**存储链路状态通告LSA**。

2）**通过各路由器洪泛发送封装有各自链路状态通告LSA的链路状态更新分组LSU，各路由器的链路状态数据库LSDB最终将达到一致。**

![image-20221224191431691](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191431691.png)

**基于链路状态数据库进行最短路径优先计算**

1）使用OSPF的各路由器，**基于链路状态数据库LSDB进行最短路径优先计算**，构建出各自到达其他各路由器的最短路径，即**构建各自的路由表**。

![image-20221224191609302](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191609302.png)

#### 2、OSPF的五种分组类型

![image-20221224191658234](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191658234.png)

#### 3、OSPF的基本工作过程

![image-20221224191721010](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191721010.png)

#### 4、多点接入网络中的OSPF路由器

1）在多点接入网络中OSPF路由器邻居关系的建立

![image-20221224191829395](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191829395.png)

2）为了**减少洪泛发送问候分组和链路状态更新分组的数量**，OSPF采用以下措施：

- 选举**指定路由器**（Designated Router，**DR**）和**备用的指定路由器**（Backup Designated Router，**BDR**）
- **所有的非DR/BDR只与DR/BDR建立邻居关系**
- **非DR/BDR之间通过DR/BDR交换信息**

![image-20221224191936874](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224191936874.png)

#### 5、OSPF划分区域

1）为了使OSPF协议能够**用于规模很大的网络**，OSPF**把一个自治系统AS再划分为若干个更小的范围**，称为**区域**（area）。

![image-20221224192045369](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192045369.png)

> 划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限于每一个区域，而不是整个自治系统AS，这样就减少了整个网络上的通信量。

![image-20221224192111691](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192111691.png)

> - 自治系统边界路由器（AS Border Router，**ASBR**）：R6
> - 主干路由器（Backbone Router，**BBR**）：R3、R4、R5、R6和R7
> - 区域内路由器（Internal Router，**IR**）：区域1内的R1和R2，区域2内的R8，区域3内的R9
> - 区域边界路由器（Area Border Router，**ABR**）：R3、R4和R7

![image-20221224192224715](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192224715.png)

> 采用划分区域的方法，虽然使交换信息的种类增多了，同时也使OSPF协议更加复杂了，但这样做能使每一个区域内部交换路由信息的通信量大大减小，因而使OSPF协议能够用于规模更大的自治系统AS。

![image-20221224192252821](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192252821.png)

### 4.4.5 边界网关协议

#### 1、边界网关协议BGP的相关基本概念

1）边界网关协议（Border Gateway Protocol，**BGP**）属于外部网关协议EGP这个类别，用于**自治系统AS之间的路由选择协议**。

2）由于在不同AS内度量路由的“代价”（距离、带宽、费用等）可能不同，因此**对于AS之间的路由选择，使用统一的“代价”作为度量来寻找最佳路由是不行的**。

![image-20221224192407791](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192407791.png)

![image-20221224192429050](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192429050.png)

> 哪条路径是最佳路由呢？
>
> **没有统一的路由度量寻找最佳路由是无意义的**

3）AS之间的路由选择还必须考虑相关**策略**（政治、经济、安全等）。

![image-20221224192525849](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192525849.png)

> 自治系统之间的路由选择协议应当允许使用多种路由选择策略。这些策略包括政治、经济、安全等，它们都是由网络管理人员对每一个路由器进行设置的。但这些策略并不是自治系统之间的路由选择协议本身。

> BGP只能是力求寻找一条能够到达目的网络且比较好的路由（即不能兜圈子），而并非要寻找一条最佳路由

4）在配置BGP时，每个AS的管理员要选择至少一个路由器作为该AS的“**BGP发言人**”。

5）一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是**BGP边界路由器**。

6）使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站**（neighbor）或**对等站**（peer）。

7）BGP发言人除了运行BGP协议外，还必须运行自己所在AS所使用的内部网关协议IGP，例如RIP或OSPF。

8）BGP发言人交换网络可达性的信息，也就是**要到达某个网络所要经过的一系列自治系统**。

![image-20221224192703966](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192703966.png)

9）当BGP发言人相互交换了网络可达性的信息后，各BGP发言人就**根据**所采用的**策略**，从收到的路由信息中**找出到达各自治系统的较好的路由**，也就是构造出树形结构且**不存在环路的自治系统连通图**。

![image-20221224192740557](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192740557.png)

10）BGP适用于多级结构的因特网。

![image-20221224192801695](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192801695.png)

#### 2、BGP-4的四种报文

1）BGP-4是目前使用得最多的版本，在[RFC 4271]中规定了BGP-4的四种报文：

![image-20221224192831072](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192831072.png)

**边界网关协议BGP**

![image-20221224192915641](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192915641.png)

![image-20221224192926555](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224192926555.png)

> 从实现功能（路由选择）的角度看，这三个路由选择协议都属于网络层。
>
> 从数据包按网络体系结构逐层封装的角度看，RIP和BGP属于应用层，OSPF属于网络层。

### 4.4.6 路由器的基本工作原理

1）**路由器**是一种具有多个输入端口和输出端口的**专用计算机**，其任务是**转发分组**。

![image-20221224193035708](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193035708.png)

**流程**

![image-20221224193104805](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193104805.png)

![image-20221224193115013](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193115013.png)

![image-20221224193122862](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193122862.png)

![image-20221224193130814](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193130814.png)

![image-20221224193140807](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193140807.png)

![image-20221224193153734](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193153734.png)

![image-20221224193203407](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193203407.png)

![image-20221224193216430](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193216430.png)

![image-20221224193229415](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193229415.png)

![image-20221224193248656](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193248656.png)

![image-20221224193302200](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193302200.png)

![image-20221224193310360](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193310360.png)

![image-20221224193319008](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193319008.png)

> - 交换结构的速率对于路由器的性能是至关重要的。因此，人们对交换结构进行了大量研究，以提高路由器的转发速率。
> - 实现交换结构的三种基本方式是：**通过存储器**、**通过总线**以及**通过互连网络**。这三种交换结构可实现的路由器转发速率依次提高。有兴趣的同学可自行查阅相关资料。

## 4.5 网际控制报文协议

### 1、网际控制报文协议概述

1）为了更**有效地转发IP数据报**以及提高IP数据报交付成功的机会，TCP/IP体系结构的**网际层**使用了**网际控制报文协议**（Internet Control Message Protocol，**ICMP**）[RFC 792]。

2）**主机**或**路由器**使用ICMP来发送**差错报告报文**和**询问报文**。

3）**ICMP报文被封装在IP数据报中发送。**

![image-20221224193521146](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193521146.png)

### 2、ICMP报文类型

1）ICMP 报文分为以下两大类

![image-20221224193559854](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221224193559854.png)

**差错报告报文**

常见的ICM差错报告报文有以下五种：

- **终点不可达**
- **源点抑制**
- **时间超过（超时）**
- **参数问题**
- **改变路由（重定向）**

1）终点不可达

**当路由器或主机不能交付IP数据报时，就向源点发送终点不可达报文。**具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种。

![image-20221226185658905](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226185658905.png)

2）源点抑制

**当路由器或主机由于拥塞而丢弃IP数据报时，就向发送该IP数据报的源点发送源点抑制报文**，使源点知道应当把IP数据报的发送速率放慢。

![image-20221226185846065](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226185846065.png)

![image-20221226185900146](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226185900146.png)

3）时间超过（超时）

当路由器收到一个目的IP地址不是自己的IP数据报时，会将其首部中**生存时间TTL字段的值减1**。若结果不为0，则路由器将该数据报转发出去；**若结果为0，路由器不但要丢弃该数据报，还要向发送该IP数据报的源点发送时间超过（超时）报文**。

![image-20221226190007612](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190007612.png)

另外，当**终点在预先规定的时间内未能收到一个数据报的全部数据报分片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过（超时）报文**。

4）参数问题

当路由器或目的主机收到IP数据报后，根据其首部中的检验和字段的值发现**首部**在传送过程中出现了**误码**，就**丢弃该数据报**，并**向发送该数据报的源点发送参数问题报文**。

![image-20221226190133365](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190133365.png)

5）改变路由（重定向）

路由器把改变路由报文发送给主机，**让主机知道下次应将IP数据报发送给另外的路由器**，这样可以**通过更好的路由到达目的主机**。

![image-20221226190220679](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190220679.png)

![image-20221226190236719](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190236719.png)



以下情况**不应该发送ICMP差错报告报文**

- 对ICMP差错报告报文不再发送ICMP差错报告报文。
- 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文。
- 对具有多播地址的IP数据报都不发送ICMP差错报告报文。
- 对具有特殊地址（例如127.0.0.0或0.0.0.0）的IP数据报不发送ICMP差错报告报文。

![image-20221226190446940](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190446940.png)



**询问报文**

常见的ICMP询问报文有以下两种：

![image-20221226190529134](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190529134.png)

### 3、ICMP的典型应用

- 分组网间探测(Packet InterNet Groper，**PING**）
- 跟踪路由(traceroute）

**分组网建探测PING**

1）分组网间探测PING用来**测试主机或路由器之间的连通性**。

- PING是TCP/IP体系结构的**应用层直接使用网际层ICMP**的一个例子，它并不使用运输层的TCP或UDP。
- PING应用所**使用的ICMP报文类型为回送请求和回答**。

**跟踪路由**

1）跟踪路由应用traceroute，用于**探测IP数据报从源主机到达目的主机要经过哪些路由器**。

2）在不同操作系统中，traceroute应用的命令和实现机制有所不同：

- 在**UNIX版本**中，具体命令为“**traceroute**”，其在运输层使用**UDP协议**，在网络层使用**ICMP报文类型只有差错报告报文**。
- 在**Windows版本**中，具体命令为“**tracert**”，其**应用层直接使用网际层的ICMP协议**，所使用的**ICMP报文类型有回送请求和回答报文以及差错报告报文**。

![image-20221226190910650](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190910650.png)

![image-20221226190922599](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190922599.png)

![image-20221226190936176](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226190936176.png)

## 4.6 虚拟专用网和网络地址转换

### 1、虚拟专用网

1）虚拟专用网（Virtual Private Network，**VPN**）：**利用公用的因特网**作为本机构各专用网之间的通信载体，这样形成的网络又称为虚拟专用网。

![image-20221226191112010](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191112010.png)

![image-20221226191136493](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191136493.png)

> 出于安全考虑，**专用网内的各主机并不应该直接“暴露”于公用的因特网上**。因此，给专用网内各主机配置的IP地址应使各主机在专用网内可以相互通信，而不能直接与公用的因特网通信。

2）给专用网内各主机配置的IP地址应该是该**专用网所在机构可以自行分配的IP地址**，这类IP地址仅在机构内部有效，称为**专用地址**（Private Address），不需要向因特网的管理机构申请。

3）[RFC 1918]规定了以下三个CIDR地址块中的地址作为专用地址：

- 10.0.0.0~10.255.255.255（CIDR地址块10/8）
- 172.16.0.0~172.31.255.255（CIDR地址块172.16/12）
- 192.168.0.0~192.168.255.255（CIDR地址块192.168/16）

> 很显然，全世界可能有**很多不同机构的专用网具有相同的专用IP地址**，但这并不会引起麻烦，因为这些专用地址仅在机构内部使用。
>
> 在因特网中的所有路由器，对目的地址是专用地址的IP数据报一律不进行转发，这需要由因特网服务提供者ISP对其拥有的因特网路由器进行设置来实现。

![image-20221226191322036](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191322036.png)

![image-20221226191357939](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191357939.png)

![image-20221226191426179](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191426179.png)

![image-20221226191451019](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191451019.png)

> 虽然两个专用网内的主机间发送的数据报是通过公用的因特网传送的，但从效果上就好像是本机构的专用网上传送一样，这也是虚拟专用网中“虚拟”的含义。

![image-20221226191514980](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191514980.png)

> IP数据报在因特网中可能要经过多个网络和路由器，但从逻辑上看，路由器R1和R2之间好像是一条直通的点对点链路，因此也被称为IP隧道技术。

本例所示的是同一机构内不同部门的内部网络所构成的VPN，又称为**内联网VPN**。

有时，一个机构的虚拟专用网VPN需要某些外部机构（通常是合作伙伴）参加进来，这样的VPN就称为**外联网VPN**。

在外地工作的员工需要访问公司内部的专用网时，只要在任何地点接入因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，就可以访问专用网中的资源，这种虚拟专用网又称为**远程接入VPN**。

> 2017年，工信部下发了《工业和信息化部关于清理规范互联网网络接入服务市场的通知》。在我国，未经电信主管部门批准，不得自行建立或租用专线（含虚拟专用网络VPN ）等其他信道开展跨境经营活动。

### 2、网络地址转换

1）尽管因特网采用了无分类编址方法来减缓IPv4地址空间耗尽的速度，但由于**因特网用户数量的急剧增长**，特别是**大量小型办公室**和**家庭网络**接入因特网的需求不断增加，**IPv4地址空间即将耗尽的危险然仍没有解除**（实际上，因特网号码分配管理局IANN于2011年2月3日宣布，IPv4地址已经分配完毕）。

2）**网络地址转换**（Network Address Translation，**NAT**）技术于1994年被提出，用来缓解IPv4地址空间即将耗尽的问题。

- NAT能**使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源**。
- 这种方法需要在专用网络连接到因特网的路由器上**安装NAT软件**。装有NAT软件的路由器称为**NAT路由器**，它**至少要有一个有效的外部全球地址IP<sub>G</sub>**。这样，所有使用内部专用地址的主机在和外部因特网通信时，都要**在NAT路由器上将其内部专用地址转换成IP<sub>G</sub>**。

**最基本的NAT方法**

![image-20221226191928690](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226191928690.png)

> NAT路由器至少要有一个有效的外部全球地址IP<sub>G</sub>

![image-20221226192040873](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226192040873.png)

![image-20221226192102929](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226192102929.png)

> 缺点：
>       如果NAT路由器拥有n（n比较小）个全球IP地址，那么专用网内**最多可以同时**有n台主机接入因特网。若专用网内的主机数量大于n，则需要轮流使用NAT路由器中数量较少的全球IP地址。

**网络地址和端口号转换方法**

1）由于目前绝大多数基于TCP/IP协议栈的网络应用，都使用运输层的传输控制协议TCP或用户数据报协议UDP，为了**更加有效地利用NAT路由器中的全球IP地址**，现在常**将NAT转换和运输层端口号结合使用**。

- 这样就可以使内部专用网中使用专用地址的**大量主机，共用NAT路由器上的1个全球IP地址**，因而可以同时与因特网中的不同主机进行通信。

2）将NAT和运输层端口号结合使用，称为**网络地址与端口号转换**（Network Address and Port Translation，**NAPT**）

- 现在很多家用路由器将家中各种智能设备（手机、平板、笔记本电脑、台式电脑、物联网设备等）接入因特网，这种路由器实际上就是一个**NAPT路由器**，但往往并不运行路由选择协议。

![image-20221226192339127](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226192339127.png)

> `192.168.0.9:30000`与主机A选择的源端口号相同，这纯属巧合（端口号仅在本主机中才有意义）。特意这样举例，就是为了能更好地说明NAPT路由器还会对源端口号重新动态分配。

![image-20221226192418128](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226192418128.png)

3）尽管NAT（和NAPT）的出现在很大程度上缓解了IPv4地址资源紧张的局面，但**NAT（和NAPT）对网络应用并不完全透明**，会对某些网络应用产生影响。

4）NAT（和NAPT）的一个重要特点就是**通信必须由专用网内部发起，因此拥有内部专用地址的主机不能直接充当因特网中的服务器**。

![image-20221226192549083](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221226192549083.png)

5）对于目前P2P这类需要外网主机主动与内网主机进行通信的网络应用，在通过NAT时会遇到问题，需要网络应用自身使用一些特殊的**NAT穿透技术**来解决。

## 4.7 IP多播

### 4.7.1 IP多播技术的相关基本概念

1）**多播**（Multicast，也称为组播）是一种实现“**一对多**”通信的技术，与传统单播“一对一”通信相比，多播可以**极大地节省网络资源**。

2）在**因特网上进行的多播**，称为**IP多播**。

![image-20221227151206067](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227151206067.png)

> 当多播组的成员数量很大时，采用多播方式可以显著地减少网络中各种资源的消耗

> 要在因特网上实现IP多播，则因特网中的路由器需要解决哪些主要问题？
>
> - IP多播数据报的寻址
> - 多播路由选择寻址

### 4.7.2 IP多播地址和多播组

1）在**IPv4中**，**D类地址**被作为**多播地址**。

2）**多播地址只能用作目的地址**，而不能用作源地址。

3）用每一个D类地址来标识一个多播组，**使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组**。

![image-20221227151448040](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227151448040.png)

- **每个多播组的成员是可以随时变动的**，一台主机可以随时加入或离开多播组。
- **多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组**。

4）非多播组成员也可以向多播组发送IP多播数据报。

5）与IP数据报相同，IP多播数据报也是“**尽最大努力交付**”，不保证一定能够交付给多播组内的所有成员。

6）IPv4多播地址又可分为**预留的多播地址**（永久多播地址）、**全球范围可用的多播地址**以及**本地管理的多播地址**[RFC 3330]。

![image-20221227151624819](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227151624819.png)

7）IP多播地址可以分为以下两种

- 只在**本局域网**上进行的**硬件多播**
- 在**因特网**上进行的**多播**

> 目前大部分主机都是通过局域网接入因特网的。因此，在因特网上进行多播的最后阶段，还是要把IP多播数据报在局域网上用硬件多播交付给多播组的所有成员。

### 4.7.3 在局域网上进行硬件多播

1）由于MAC地址（也称为硬件地址）有多播MAC地址这种类型，因此只要**把IPv4多播地址映射成多播MAC地址**，即可将IP多播数据报封装在局域网的MAC帧中，而MAC帧首部中的目的MAC地址字段的值，就设置为由IPv4多播地址映射成的多播MAC地址。这样，可以很方便地**利用硬件多播来实现局域网内的IP多播**。

2）当给某个多播组的成员主机配置其所属多播组的IP多播地址时，系统就会根据映射规则从该IP多播地址生成相应的局域网多播MAC地址。

![image-20221227151853976](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227151853976.png)

3）因特网号码指派管理局IANA，将自己从IEEE注册管理机构申请到的以太网MAC地址块中从**01-00-5E-00-00-00到01-00-5E-7F-FF-FF**的多播MAC地址，用于映射IPv4多播地址。

- 这些多播MAC地址的**左起前25个比特都是相同的**，**剩余23个比特可以任意变化**，因此共有2^23个。

![image-20221227151947999](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227151947999.png)

![image-20221227152007104](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152007104.png)

【举例】**IP多播地址与多播MAC地址的映射关系并不是唯一的。**

![image-20221227152236323](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152236323.png)

![image-20221227152249370](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152249370.png)

> 由于IP多播地址与多播MAC地址的映射关系不是唯一的，因此**收到IP多播数据报的主机还要在网际层利用软件进行过滤**，把不是主机要接收的IP多播数据报丢弃。

【举例】收到IP多播数据报的主机还要**在网际层利用软件进行过滤**，把不是主机要接收的IP多播数据报丢弃

![image-20221227152410851](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152410851.png)

### 4.7.4 在因特网上进行IP多播需要的两种协议

1）要在因特网上进行IP多播，就必须要考虑**IP多播数据报经过多个多播路由器进行转发**的问题。

- **多播路由器**必须**根据**IP多播数据报首部中的**IP多播地址**，将其**转发**到有该多播组成员的局域网。

![image-20221227152540041](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152540041.png)

> 路由器如何知道自己各接口所在局域网中是否有某个多播组的成员？
>
> **网际组管理协议IGMP**

2）网际组管理协议（Internet Group Management Protocol，**IGMP**）是TCP/IP体系结构网际层中的协议，其作用是**让连接在本地局域网上的多播路由器知道本局域网上是否有主机（**实际上是主机中的某个进程）**加入或退出了某个多播组**。

![image-20221227152641272](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152641272.png)

3）**IGMP仅在本网络有效**，使用IGMP**并不能知道**多播组所包含的**成员数量**，**也不能知道**多播组的**成员都分布**在哪些网络中。

> 仅使用IGMP并不能在因特网上进行IP多播。连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把IP多播数据报用最小的代价传送给所有的多播组成员，这就需要使用**多播路由选择协议**。

4）**多播路由选择协议**的主要任务是：在多播路由器之间为每个多播组建立一个**多播转发树**。

- 多播转发树**连接多播源和所有拥有该多播组成员的路由器**。
- **IP多播数据报只要沿着多播转发树进行洪泛**，就能被传送到所有拥有该多播组成员的多播路由器。
- 之后，**在多播路由器所直连的局域网内**，多播路由器通过**硬件多播**，将IP多播数据报发送给该多播组的所有成员。

![image-20221227152903774](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227152903774.png)

- 为了覆盖多播组的所有成员，**多播转发树可能要经过一些没有多播组成员的路由器**（例如上图中的R2）。

### 4.7.5 网际组管理协议

#### 1、IGMP的三种报文类型

1）网际组管理协议IGMP目前的最新版本是2002年10月公布的IGMPv3[RFC 3376]。

2）IGMP有三种报文类型：

- 成员报告报文
- 成员查询报文
- 离开组报文

3）IGMP报文被封装在IP数据报中传送

![image-20221227153145433](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153145433.png)

#### 2、网际组管理协议IGMP的基本工作原理

**1）加入多播组**

![image-20221227153318473](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153318473.png)

![image-20221227153330827](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153330827.png)

**2）监视多播组的成员变化**

![image-20221227153402506](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153402506.png)

![image-20221227153414764](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153414764.png)

![image-20221227153429748](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153429748.png)

![image-20221227153504013](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153504013.png)

![image-20221227153520189](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153520189.png)

![image-20221227153538263](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153538263.png)

> 1、同一网络中的多播路由器可能不止一个，但 没有必要每个多播路由器都周期性地发送IGMP成员查询报文。
>
> 2、只要在这些多播路由器中选择一个作为**查询路由器**，由查询路由器发送IGMP成员查询报文，而其他的多播路由器仅被动接收响应并更新自己的多播组列表即可。
>
> 3、选择查询路由器的方法：
>
> - 每个多播路由器若监听到源IP地址比自己的IP地址小的IGMP成员查询报文则退出选举。
> - 最后，网络中只有**IP地址最小的多播路由器成为查询路由器**。

**3）退出多播组**

IGMPv2在IGMPv1的基础上增加了一个可选项：当主机要退出某个多播组时，可主动发送一个**离开组报文**而不必等待多播路由器的查询。这样**可使多播路由器能够更快地发现某个组有成员离开**。

![image-20221227153737702](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153737702.png)

![image-20221227153752922](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227153752922.png)

### 4.7.6 多播路由选择协议

#### 1、多播路由选择协议

1）多播路由选择协议的主要任务是：**在多播路由器之间为每个多播组建立一个多播转发树**。

- 多播转发树连接多播源和所拥有该多播组成员的路由器。

2）目前有以下两种方法来构建多播转发树：

- **基于源树**（Source-Base Tree）多播路由选择
- **组共享树**（Group-Shared Tree）多播路由选择

**基于源树多播路由选择**

1）基于源树的多播路由选择的最典型算法是**反向路径多播**（Reverse Path Multicasting，**RPM**）算法。

2）RPM算法包含以下两个步骤：

- 利用**反向路径广播**（Reverse Path Broadcasting，**RPB**）算法建立一个**广播转发树**。
- 利用**剪枝**（Pruning）算法，剪除广播转发树中的下游非成员路由器，获得一个**多播转发树**。

3）要建立广播转发树，可以使用**洪泛**（Flooding）法。

![image-20221227154035286](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154035286.png)

4）利用**反向路径广播RPB算法**生成的**广播转发树**，**不会存在环路**，因此可以避免广播分组在环路中兜圈。

5）RPB算法的要点是：每一台路由器在收到一个广播分组时，先**检查该广播分组是否是从源点经最短路径传送来的**。

- 若是，本路由器就从自己除刚才接收该广播分组的接口的所有其他接口转发该广播分组。
- 否则，丢弃该广播分组。
- 如果本路由器有好几个邻居路由器都处在到源点的最短路径上，也就是**存在好几条同样长度的最短路径**，那么只能选取一条最短路径。**选取**的规则是这几条最短路径中的**邻居路由器的IP地址最小的那条最短路径**。

6）RPB中“反向路径”的意思是：**在计算最短路径时把源点当作终点**。

![image-20221227154211496](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154211496.png)

![image-20221227154224492](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154224492.png)

![image-20221227154239548](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154239548.png)

![image-20221227154253526](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154253526.png)

![image-20221227154305023](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154305023.png)

![image-20221227154325496](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154325496.png)

> ​        将R8这样没有多播组成员（使用IGMP来探测）、并且也没有下游路由器的叶节点从广播转发树上剪除就可实现**多播转发树**。
>
> ![image-20221227154402990](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154402990.png)
>
> 若要加入，
>
> ![image-20221227154417662](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154417662.png)
>
> 尽管R2没有多播组成员，但也要保留R2以确保多播转发树的连通性。

**组共享树多播路由选择**

1）组共享树多播路由选择采用**基于核心的分布式生成树算法**来建立共享树。

- 该方法在**每个多播组**中指定一个**核心（core）路由器**，以该路由器为**根**，建立一棵**连接多播组的所有成员路由器的生成树**，作为多播转发树。

2）每个多播组中除了核心路由器，其他所有成员路由器都会向自己多播组中的核心路由器单播加入报文。

- 加入报文通过单播朝着核心路由器转发，直到它**到达**已经属于**该多播生成树的某个节点**或者**直接到达该核心路由器**。
- 加入报文所经过的路径，就确定了一条**从单播该报文的边缘节点到核心路由器之间的分支**，而这个新分支就被**嫁接**到现有的**多播转发树**上。

![image-20221227154659806](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154659806.png)

![image-20221227154710158](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154710158.png)

![image-20221227154723111](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154723111.png)

#### 2、因特网的多播路由选择协议

1）**目前还没有在整个因特网范围使用的多播路由选择协议**。下面是一些建议使用的多播路由选择协议：

![image-20221227154839447](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227154839447.png)

2）尽管因特网工程任务组IETF努力推动着因特网上的**全球多播主干网**（Multicast Backbone On the Internet，**MBONE**）的建设，但至今在因特网上的IP多播还没有得到大规模的应用。

- 主要原因是：**改变一个已成功运行且广泛部署的网络层协议是一件及其困难的事情**。
- 目前IP多播主要应用在一些局部的园区网络、专用网络或者虚拟专用网中。

> 另外，P2P技术的广泛应用推动了**应用层多播技术**的发展，许多视频流公司和内容分发公司，通过构建自己的应用层多播覆盖网络来分发它们的内容。但上述多播路由选择协议的算法思想在应用层多播中依然适用。

## 4.8 移动IP技术

### 1、移动性对因特网应用的影响

![image-20221227155002393](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155002393.png)

### 2、移动IP技术的相关基本概念

1）**移动IP**（Mobile IP）是因特网工程任务组IETF开发的一种技术[RFC 3344]，该技术使得**移动主机在各网络之间漫游时，仍然能够保持其原来的IP地址不变**。

2）移动IP技术还为因特网中的非移动主机提供了相应机制，使得它们能够将IP数据报正确发送到移动主机。

![image-20221227155103037](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155103037.png)

### 3、移动IP技术的基本工作原理

**1）代理发现与注册**

![image-20221227155159168](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155159168.png)

![image-20221227155217488](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155217488.png)

![image-20221227155229651](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155229651.png)

**2）固定主机向移动主机发送IP数据报**

![image-20221227155300714](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155300714.png)

![image-20221227155328210](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155328210.png)

> 所有使用同一外地代理的移动主机都可以共享同一个转交地址。
>
> 当外地代理从IP隧道中收到并解封出原IP数据报时，会在自己的代理注册表中查找移动主机的永久地址所对应的MAC地址，并将该数据报封装到目的地址为该MAC地址的帧中发送给移动主机。
>
> 这**与4.2.6节中的IP数据报的正常转发流程是不同的**，否则会造成该数据报又被发回移动主机的归属网络。

**3）移动主机向固定主机发送 IP数据报**

![image-20221227155503748](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155503748.png)

![image-20221227155525334](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155525334.png)

> 为此，移动主机可以将**外地代理**作为自己的**默认路由器**，也可以通过代理发现协议从外地代理获取**外地网络中其他路由器**的地址，并将其设置为自己的**默认路由器**。

**4）同址转交地址方式**

![image-20221227155637634](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155637634.png)

**5）三角形路由问题**

![image-20221227155701777](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221227155701777.png)

>  即使在固定主机与移动主机之间存在一条更有效的路径，发往移动主机的IP数据报也要先发送给归属代理，造成IP数据报转发的低效。
>
>  
>
>  解决三角形路由问题的一种方法：
>        给固定主机配置一个**通信代理**，固定主机发送给移动主机的IP数据报，都要通过该**通信代理转发**。
>        通信代理先从归属代理获取移动主机的转交地址，之后所有发送给移动主机的IP数据报，都利用转交地址直接通过IP隧道发送给移动主机的外地代理，而无须再通过移动主机的归属代理进行转发。
>        这种方法以增加复杂性为代价，并要求固定主机也要配置通信代理，也就是对固定主机不再透明。

## 4.9 IPv6地址

### 4.9.1 IPv6引进的主要变化

#### 1、IPv6的诞生背景

![image-20221228165420288](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228165420288.png)

1）IPv4是在20世纪70年代末期设计的，**其IPv4地址的设计存在以下缺陷**：

- IPv4的设计者最初并没有想到该协议会在全球范围内广泛使用，因此将**IPv4地址的长度**规定为他们认为足够长的**32比特**。
- IPv4地址**早期的编址方法**（分类的IPv4地址和划分子网的IPv4地址）也**不够合理**，**造成IPv4地址资源的浪费**。

2）因特网经过几十年的飞速发展，到**2011年2月3日**，因特网号码分配管理局IANA宣布**IPv4地址**已经分配完毕，因特网服务提供者ISP已经不能再申请到新的IPv4地址块。

- 我国在2014至2015年也逐步停止向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6。

3）如果没有**网络地址转换NAT**技术的广泛应用，IPv4早已停止发展。

4）然而，NAT仅仅是为了延长IPv4使用寿命而采取的权宜之计，**解决IPv4地址耗尽的根本措施就是采用具有更大地址空间（IP地址的长度为128比特）的新版本IP，即IPv6**。

5）因特网工程任务组IETF早在1992年6月就提出要制定下一代的IP，即IPng（IP Next Generation）。IPng现在正式称为IPv6。

6）**直接将因特网的核心协议从IPv4更换成IPv6是不可行的。**

- 世界上许多团体都从因特网的发展中看到了机遇，因此在IPv6标准的制定过程中**出于自身经济利益**而产生了激烈的争论。

7）到目前为止，IPv6还只是**草案标准**阶段[RFC 2460，RFC 4862，RFC 4443]。

8）尽早开始过渡到IPv6有以下好处：

- 有更多时间来平滑过渡
- 有更多时间来培养IPv6的专门人才
- 及早提供IPv6服务比较便宜

> ​        在2021年中国IPv6创新发展大会上，工业和信息化部总工程师韩夏表示：“中国IPv6网络基础设施规模全球领先，已申请的IPv6地址资源位居全球第一”。
> ​         目前，我国IPv6这条信息的“高速公路”已基本全面建成。在这其中，三大运营商贡献了巨大的力量。

#### 2、IPv6引进的主要变化

![image-20221228165815153](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228165815153.png)

###  4.9.2 IPv6数据报的基本首部

![image-20221228165932807](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228165932807.png)

> 注意：
>
> 所有的扩展首部并不属于IPv6数据报的首部，它们与其后面的数据部分合起来构成有效载荷（payload，也称为净负荷）

![image-20221228170011307](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228170011307.png)

**IPv6 VS IPv4**

![image-20221228182813308](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228182813308.png)

1）IPv6将IPv4数据报首部中不必要的功能取消了，这使得**IPv6数据报基本首部中的字段数量减少到只有8个**。

- 但由于IPv6地址的长度扩展到了128比特，因此使得**IPv6数据报基本首部的长度反而增大到了40字节**，比IPv4数据报首部固定部分的长度（20字节）增大了20字节。

2）取消了首部长度字段，因为IPv6数据报的首部长度是固定的40字节。

3）取消了区分服务（服务类型）字段，因为IPv6数据报首部中的通信量类和流标号字段实现了区分服务字段的功能。

4）取消了总长度字段，改用有效载荷长度字段。这是因为IPv6数据报的首部长度是固定的40字节，只有其后面的有效载荷长度是可变的。

5）取消了标识、标志和片偏移字段，因为这些功能已包含在IPv6数据报的分片扩展首部中。

6）把生存时间TTL字段改称为跳数限制字段，这样名称与作用更加一致。

7）取消了协议字段，改用下一个首部字段。

8）取消了首部检验和字段，这样可以加快路由器处理IPv6数据报的速度。

9）取消了选项字段，改用扩展首部来实现选项功能。

**IPv6数据报格式**

![image-20221228183041412](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228183041412.png)

1）版本字段：长度为4比特，用来表示IP协议的版本。对于IPv6该字段的值是6。

2）通信量类字段：长度为8比特，该字段用来**区分不同的IPv6数据报的类别或优先级**。目前正在进行不同的通信量类性能的实验。

3）流标号字段：长度为20比特。

- IPv6提出了**流**的抽象概念。
- **“流”就是因特网上从特定源点到特定终点（单播或多播）的一系列IPv6数据报（如实时音视频数据的传送），而在这个“流”所经过的路径上的所有路由器都保证指明的服务质量。**
- 所有属于同一个流的IPv6数据报都具有同样的流标号。换句话说，**流标号用于资源分配**。
- 流标号对于实时音视频数据的传送特别有用，但对于传统的非实时数据，流标号则没有用处，把流标号字段的值置为0即可。

4）有效载荷长度字段：长度为16比特，它**指明IPv6数据报基本首部后面的有效载荷（包括扩展首部和数据部分）的字节数量**。

- 该字段以字节为单位，最大取值为65535，因此IPv6数据报基本首部后面的有效载荷的最大长度为65535字节。

5）下一个首部字段：长度为8比特。该字段相当于IPv4数据报首部中的**协议字段或可选字段**。

- **当IPv6数据报没有扩展首部时**，该字段的作用与IPv4的协议字段一样，它的值指出了IPv6数据报基本首部后面的数据是何种协议数据单元PDU。

  ![image-20221228183457563](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228183457563.png)

  ![image-20221228183511195](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228183511195.png)

- **当IPv6数据报基本首部后面带有扩展首部时**，该字段的值就标识后面第一个扩展首部的类型。

  ![image-20221228183550438](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228183550438.png)

- 跳数限制字段：长度为8比特。该字段用来防止**IPv6数据报在因特网中永久兜圈**。

  - 源点在每个IPv6数据报发出时即设定某个跳数限制（最大255跳）。
  - 每个路由器在转发IPv6数据报时，要先把跳数限制字段中的值减1。当跳数限制的值为0时，就把这个IPv6数据报丢弃（即不转发）。

  > 该字段的作用与IPv4数据报首部中的生存时间TTL字段完全一样。IPv6将名称改为跳数限制后，可使名称与作用更加一致。

- 源地址字段和目的地址字段：长度都为**128比特**。分别用来填写IPv6数据报的发送端的IPv6地址和接收端的IPv6地址。

### 4.9.3 IPv6数据报的扩展首部

1）**IPv4数据报**如果在其首部中**使用了选项字段**，则在数据报的整个传送路径中的全部路由器，都要对选项字段进行检查，这就降低了**路由器处理数据报的速度**。

2）实际上，在路径中的路由器对很多选项是不需要检查的。因此，**为了提高路由器对数据包的处理效率，IPv6把原来IPv4首部中的选项字段都放在了扩展首部中**，由路径两端的源点和终点的主机来处理，而**数据报传送路径中的所有路由器都不处理这些扩展首部**（除逐跳选项扩展首部）。

3）在[RFC 2460]中定义了以下六种扩展首部：

- 逐跳选项
- 路由选择
- 分片
- 鉴别
- 封装安全有效载荷
- 目的站选项

4）**每一个扩展首部都由若干个字段组成**，它们的长度也各不相同。

5）**所有扩展首部中的第一个字段都是8比特的下一个首部字段**。该字段的值指出在该扩展首部后面是何种扩展首部。

6）当使用多个扩展首部时，**应按以上的先后顺序出现**。

### 4.9.4 IPv6地址

#### 1、IPv6地址空间大小

1）在IPv6中，每个地址占**128个比特**。

![image-20221228184039270](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184039270.png)

- 如果**整个地球表面**（包括陆地和水面）都覆盖着需要IPv6地址的通信设备，那么IPv6允许**每平方米拥有7×10^23个IPv6地址**。
- 如果IPv6地址分配速率是**每微秒分配100万个IPv6地址**，则需要**10^19^**年的时间才能将所有可能的地址分配完毕。

2）很显然，这样巨大的地址空间在**采用合理编址方法**的情况下，**在可预见的未来是不会用完的**。

#### 2、IPv6地址的表示方式

![image-20221228184207184](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184207184.png)

1）在IPv6地址的冒号十六进制记法的基础上，再使用**“左侧零”省略**和**“连续零”压缩**，可使IPv6地址的表示**更加简洁**。

- “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0可以省略不写。
- “连续零”压缩是指一连串连续的0可以用一对冒号取代。

![image-20221228184243571](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184243571.png)

2）**在一个IPv6地址中只能使用一次“连续零”压缩**，否则会导致歧义。

![image-20221228184310184](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184310184.png)

![image-20221228184321198](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184321198.png)

3）**冒号十六进制记法还可结合点分十进制的后缀**。这在IPv4向IPv6过渡阶段非常有用。

![image-20221228184341238](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184341238.png)

4）CIDR的斜线表示法在IPv6中仍然可用。

![image-20221228184532470](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184532470.png)

#### 3、IPv6地址的分类

1）IPv6数据报的**目的地址**有三种基本类型

![image-20221228184643478](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228184643478.png)

2）[RFC 4291]对IPv6地址进行了分类：

**未指明地址**

1. 128个比特为“全0”的地址，可缩写为两个冒号“::”。
2. 该地址不能用作目的地址，只能用于还没有配置到一个标准IPv6地址的主机用作源地址。
3. 未指明地址仅有一个。

**环回地址**

1. 最低比特为1，其余127个比特为“全0”，即0:0:0:0:0:0:0:1，可缩写为::1。
2. 该地址的作用与IPv4的环回地址相同。
3. IPv6的环回地址只有一个。

**多播地址**

1. 最高8比特为“全1”的地址，可记为FF00::/8。
2. IPv6多播地址的功能与IPv4多播地址相同。
3. 这类地址占IPv6地址空间的1/256。

**本地链路单播地址**

1. 最高10比特为1111111010的地址，可记为FE80::/10。
2. 即使用户网络没有连接到因特网，但仍然可以使用TCP/IP协议。连接在这种网络上的主机都可以使用本地链路单播地址进行通信，但不能和因特网上的其他主机通信。
3. 这类地址占IPv6地址空间的1/1024。

**全球单播地址**

1. 全球单播地址是使用得最多的一类地址。

2. IPv6全球单播地址采用三级结构，这是为了使路由器可以更快地查找路由。

   ![image-20221228185219358](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228185219358.png)

### 4.9.5 从IPv4向IPv6过渡

#### 1、从IPv4向IPv6过渡

1）因特网上使用IPv4的路由器的数量太大，要让所有路由器都改用IPv6并不能一蹴而就。因此，**从IPv4转变到IPv6只能采用逐步演进的办法**。

2）另外，**新部署的IPv6系统必须能够向后兼容**，也就是IPv6系统必须能够接收和转发IPv4数据报，并且能够为IPv4数据报选择路由。

3）两种由IPv4向IPv6过渡的策略：

- **使用双协议栈**
- **使用隧道技术**

> 相关文档为[RFC 2473，RFC 2529，RFC 2893，RFC 3056，RFC 4038，RFC 4213]。

#### 2、使用双协议栈

1）双协议栈（Dual Stack）是指在完全过渡到IPv6之前，使一部分主机或路由器**装有IPv4和IPv6两套协议栈**。

2）双协议栈主机或路由器**既可以和IPv6系统通信，又可以和IPv4系统通信**。

3）双协议栈主机或路由器记为IPv6/IPv4，表明它**具有一个IPv6地址和一个IPv4地址**。

- 双协议栈主机在与IPv6主机通信时采用IPv6地址，而与IPv4主机通信时采用IPv4地址。
- 双协议栈主机通过域名系统DNS查询目的主机采用的IP地址：
  - 若DNS返回的是IPv4地址，则双协议栈的源主机就使用IPv4地址；
  - 若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址。

![image-20221228185649275](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228185649275.png)

#### 3、使用隧道技术

1）隧道技术（Tunneling）的核心思想是：

- 当IPv6数据报要进入IPv4网络时，将IPv6数据报重新封装成IPv4数据报，即整个IPv6数据报成为IPv4数据报的数据载荷。
- 封装有IPv6数据报的IPv4数据报在IPv4网络中传输。
- 当IPv4数据报要离开IPv4网络时，再将其数据载荷（即原来的IPv6数据报）取出并转发到IPv6网络。

![image-20221228185746712](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228185746712.png)

### 4.9.6 网际控制报文协议ICMPv6

#### 1、网际控制报文协议ICMPv6概述

1）由于**IPv6**与IPv4一样，都**不确保数据报的可靠交付**，因此IPv6也需要**使用**网际控制报文协议ICMP来向发送IPv6数据报的源主机**反馈一些差错信息**，相应的ICMP版本为ICMPv6。

2）**ICMPv6**比ICMPv4要复杂得多，它**合并了原来的地址解析协议ARP和网际组管理协议IGMP的功能**。因此与IPv6配套使用的网际层协议就只有ICMPv6这一个协议。

![image-20221228190049075](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190049075.png)

#### 2、ICMPv6报文的封装

1）**ICMPv6报文需要封装成IPv6数据报进行发送。**

![image-20221228190312397](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190312397.png)

![image-20221228190331645](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190331645.png)

#### 3、ICMPv6报文的分类

1）ICMPv6报文可被用来报告差错、获取信息、探测邻站或管理多播通信。

2）在对ICMPv6报文进行分类时，不同的RFC文档使用了不同的策略：

- 在[RFC 2463]中定义了六种类型的ICMPv6报文
- 在[RFC 2461]中定义了五种类型的ICMPv6报文
- 在[RFC 2710]中定义了三种类型的ICMPv6报文

3）常见的几种ICMPv6报文

![image-20221228190516669](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190516669.png)

## 4.10 软件定义网络SDN

### 4.10.1 网络层的数据层面和控制层面

#### 1、软件定义网络SDN概述

1）软件定义网络（Software Defined Network，**SDN**）的概念最早由斯坦福大学的Nick McKeown教授于2009年提出。

2）SDN最初只是学术界讨论的一种**新型网络体系结构**。

3）SDN成功案例：谷歌于2010~2012年间建立的数据中心网络B4。

4）SDN是当前网络领域最热门和最具发展前途的技术之一，成为近年来的研究热点。

#### 2、网络层的数据层面和控制层面

1）路由器的功能

- 为主机间的通信提供**转发**服务

  ![image-20221228190823719](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190823719.png)

- **路由选择**

  ![image-20221228190853992](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190853992.png)

  

2）路由器之间传送的信息

- **主机间的分组**

  ![image-20221228190956083](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228190956083.png)

- **路由信息**

  ![image-20221228191018075](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228191018075.png)

3）在SDN体系结构中，路由器中的路由软件都不存在了。因此，路由器之间不再交换路由信息。

4）在控制层面中，有一个在逻辑上集中的远程控制器。

5）逻辑上集中的远程控制器在物理上可由不同地点的多个服务器组成。

![image-20221228191105309](E:/MyFile/TyporaImgs/image-20221228191105309.png)

![image-20221228191132191](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228191132191.png)

6）远程控制器掌握各主机和整个网络的状态。

7）远程控制器能够为每一个分组计算出最佳的路由。

8）远程控制器为每一个路由器生成其正确的转发表。

![image-20221228191210698](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228191210698.png)

9）SDN这种新型网络体系结构的**核心思想：把网络的控制层面和数据层面分离，而让控制层面利用软件来控制数据层面中的许多设备**。

> 因特网本来是分散控制的，为什么现在SDN又提出了集中控制呢？
>
> SDN并非现在就要把整个因特网都改造成集中控制模式，因为这显然是不现实的。但在某些具体条件下，尤其是一些大型数据中心之间的广域网，如果采用SDN模式来建造，就可以提高网络的运行效率，还可以获得更好的经济效益。

### 4.10.2 OpenFlow协议

#### 1、OpenFlow协议概述

1）**OpenFlow**协议是一个得到高度认可的标准，在讨论SDN时往往与OpenFlow一起讨论。

2）OpenFlow协议可被看成是SDN体系结构中**控制层面与数据层面之间的通信接口**。

3）OpenFlow协议使得控制层面的控制器可以对数据层面中的物理设备进行直接访问和控制。

![image-20221228191508538](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228191508538.png)

4）OpenFlow协议的技术规范由非营利性的产业联盟**开放网络基金会**（Open Networking Foundation，**ONF**）负责制定。

- ONF的任务是致力于SDN的发展和标准化。
- SDN并未规定必须使用OpenFlow，只不过大部分SDN产品采用了OpenFlow作为其控制层面与数据层面的通信接口。
- OpenFlow从2009年底发表的1.0版开始，每年都被更新，历经12次更新，到2015年3月发布了1.5.1版，目前较为成熟的是1.3版本。

#### 2、传统意义上的数据层面的任务

1）传统意义上的数据层面的任务：**根据转发表转发分组**

2）转发分组分为以下两个步骤：

- 进行“**匹配**”：查找转发表中的**网络前缀**，进行最长前缀匹配。
- 执行“**动作**”：把分组从匹配结果指明的接口转发出去。

![image-20221228191700127](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228191700127.png)

#### 3、SDN的广义转发

1）SDN的**广义转发**分为以下两个步骤：

- 进行“**匹配**”：能够对网络体系结构中**各层（数据链路层、网络层、运输层）首部中的字段**进行匹配。
- 执行“**动作**”：不仅**转发分组**，还可以**负载均衡、重写IP首部**（类似NAT路由器中的地址转换）、人为地**阻挡或丢弃一些分组**（类似防火墙一样）。

#### 4、OpenFlow交换机和流表

1）在SDN的广义转发中，完成“匹配+动作”的设备并不局限在网络层工作，因此不再称为路由器，而称为“**OpenFlow交换机**”或“**分组交换机**”，或更简单地称为“**交换机**”。

2）相应的，在SDN中取代传统路由器中转发表的是“**流表（Flow Table）**”。

- 一个流就是穿过网络的一种**分组序列**，而在此序列中的每个分组都**共享分组首部某些字段的值**。例如，某个流可以是具有相同源IP地址和目的IP地址的一连串分组。
- OpenFlow交换机中的**流表是由SDN远程控制器来管理的**。SDN远程控制器通过一个安全信道，使用OpenFlow协议来管理OpenFlow交换机中的流表。

![image-20221228192014897](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228192014897.png)

> OpenFlow交换机：
>
> 1. 网络设备可以由不同厂商来生产，可以使用在不同类型的网络中。
> 2. 从SDN远程控制器看到的，是统一的逻辑交换功能。

3）每个OpenFlow交换机必须有**一个或多个流表**。

4）每一个流表可以包含**多个流表项**。

5）每个流表项包含三个字段：**首部字段值**（或称匹配字段）、**计数器**、**动作**。

![image-20221228192647764](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228192647764.png)

6）**首部字段值**字段包含有一组字段，用来使入分组（Incoming Packet）的对应首部与之匹配，因此又称为**匹配字段**。匹配不上的分组就被丢弃，或被发送到SDN远程控制器做更多的处理。

![image-20221228192738956](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228192738956.png)

7）在OpenFlow交换机中，既可以处理**数据链路层的帧**，也可以处理**网际层的IP数据报**，还可以处理**运输层的TCP或UDP报文**。

8）**计数器**字段是一组计数器：

- 记录已经与该流表项**匹配的分组数量**的计数器；
- 记录**该流表项上次更新到现在经历时间**的计数器。

9）**动作**字段是一组动作，当分组匹配某个流表项时，执行该流表项中动作字段指明的以下某个或多个动作：

- 把分组转发到指明的端口
- 丢弃分组
- 把分组进行复制后再从多个端口转发出去
- 重写分组的首部字段（包括数据链路层、网际层以及运输层的首部）

![image-20221228192949608](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228192949608.png)

![image-20221228193005292](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228193005292.png)

![image-20221228193022794](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228193022794.png)

### 4.10.3 SDN体系结构

#### 1、SDN体系结构及其四个关键特征

- 基于流的转发
- 数据层面与控制层面分离
- 位于数据层面分组交换机之外的网络控制功能
- 可编程的网络

![image-20221228193124682](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228193124682.png)

#### 2、SDN控制器

![image-20221228193148812](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/5143/image-20221228193148812.png)
